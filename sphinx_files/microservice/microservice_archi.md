# マイクロサービアーキテクチャとは
ビジネスドメインに基づいてモデル化された、独立デプロイ可能なサービス。
境界面についてはドメイン駆動設計から設計し、ネットワークを通じて相互通信する。

## マイクロサービスの定義
### 歴史
PCが安価になり、巨大なメインフレームにデプロイするよりも複数の安価なマシーンを利用する方がメリットが大きくなった。
さらに、コンテナサービスやコンテナオーケストレーション、パブリッククラウドにより、安価にマシーンを準備、管理することが一層簡単になった。

金融においては、この潮流はオープンAPIという形で各企業がAPIを公開することとなる。  
金融目線としても、オープンAPIは新たな手数料ビジネスとしてニーズがある。



### 特徴
マイクロサービスの一番の特徴は、ビジネスドメインに基づいてモデル化されており、独立してデプロイ可能なサービスであること。
サービス間はネットワークを介して相互に通信してシステムを形成する。
他のサービスに影響を与えることなく、独立してデプロイすることができるかがマイクロサービスであるか否かの判断基準と言っても良い。
サービスの境界をどのように引くべきかについても、明確な考え方がある。

以下のポイントで特徴を整理していく
- ビジネスドメインに基づく
- 独立性
- マイクロサービスのサイズ
- 境界面


### ビジネスドメインに基づく
web三層構造はコンウェイの法則「システムを設計する組織は、その構造をそっくりまねた構造の設計を生み出す」に従っている。
すなわち技術目線で構築された構造であり、ビジネス機能面からのアプローチではない。ビジネス目線でコードをグループ化すると、どうなるかは場合による。

ビジネスドメインからモデル化されたマイクロサービスはIT成果物（サービス）とビジネスドメインに整合性がある。
結果として、DevチームメンバーがPOと連携して、顧客へのデリバリーを意識できる。
モノリスからマイクロサービスへのP11が面白い。

> 独立性に注目が行きがちだけど、ビジネスドメインに基づいているから、デリバリーに効果があることもメリット

### 独立性
なんのためにマイクロサービスを採用するのかを明確化するのは大切。

独立性は、各サービスの作業を並行して行うことができる。
結果として、提供価値を高めるための繰り返しのリリースができるようになる。

> 疎結合となることで、機能間のソフトウェア的な組織的な独立性を高めて、開発速度向上を高める。
「開発速度を高めることができる」を深掘りするとコンテナサービスやCICDの文脈が語れると思う。


### マイクロサービスのサイズ
web三層構造でも、フロント・バックエンド・DBで分散している。
マイクロサービスとの違いはどれだけ分散しているか。

じゃあ、マイクロサービスのサイズって何？という質問に対しては、答えはない。
重要なのは以下の２つのポイントを自分がやろうとしているプロジェクトに当てはめること
- 自分達がどのくらいのサービス数であれば扱えるか（扱える範囲からスモールスタートしてステップするべき）
- マイクロサービスの境界線をどう定義すれば、独立性を確保できるか

> PJによりけりであるものの、実問題としてどう決めるかについての回答

### 境界面の定義
境界面の定義については、独立性とともにビジネス目線でサービスをモデル化することが重要。
じゃあどうするのかという問いに対する回答の一つがDDD（Domain-Driven Design）。
集約そして境界コンテキストという考えがある。
まずは、境界コンテキストの目線からサービスを区切って、ステップアップとして、集約でサービスを区切ることでステップアップしていくのもアイデア
詳細は別機会。


マイクロサービスに置いては、結合（あるモジュールに対する変更がどれだけ別のものの変更に影響するか）と凝縮（ともにあり、ともに変更されるべきものをグループ化すること）について考えると境界の定義が見えてくる
> 構造は凝縮度が高く、結合度が低い場合に安定する



### マイクロサービスアーキテクチャの難しさ
マイクロサービスはメリットはあるものの、そのメリットを享受するために多くの選択肢や難しさへの対応が必要であることは忘れてはいけない。
分散システムであることを扱うためには、新しい技術で対応したくなるが、同時に採用するのは危険。まずはMSにすることから
モノリスでは同じシステム間での通信であったが、システム間の通信に関して障害を考慮しないといけないという課題にぶつかる。






## モノリスの定義
基本的にはデプロイの単位で判断する。
システム内のすべての機能を一緒にデプロイする必要があるならモノリス。

気をつけなくてはならないのはマイクロサービスはモノリスの上位概念ではないということ。
モノリスは選択肢の一つとなる。

### モノリスの種類
以下の３種類が存在
- 単一プロセスモノリス：全部ガチガチにくっついている
- 分散モノリス：モノリスとマイクロサービスの悪いとこどり
- サードパーティ製ブラックボックスモノリス：自分でさわれないもの

### モノリスのデメリット
デプロイをめぐって、コーディングレベルでのコンフリクトが発生する。
デプロイをめぐって、タイミングを決めるために人間同士の調整が始まる。


## どうしてマイクロサービスアーキテクチャを採用するのか
モノリスもマイクロサービスも選択肢の一つであり、マイクロサービスへの移行は技術的やコスト的痛みを伴う。
採用する目的を明確化しないことには頓挫に終わる
- 達成したいことは何か
- マイクロサービスの代替案はあるか
- 移行に対する評価指標

### 達成したいことは何か
マイクロサービスを選択することで得られるメリットはマイクロサービスを採用する理由になるが、
マイクロサービスでしか得られないことではない点に注意代替案もあることを念頭に、マイクロサービスで達成したいことを考えるべき

絶対にやってはいけないのは、何を達成しようとしているのかを明確に把握デッキていない場合。
どこから移行を開始いてどのように分解するかは、マイクロサービスの採用目的に大きく依存するので、必ず目的を明確化してから取り組むこと。

いかに述べるような目的が得られるため、マイクロサービスを選択するときは核となる動機と副次的な動機を明確に切り離す。

#### 自律的なチーム
チームとして担当しているサービスに対して裁量があることは人々の活力になる。
#### 市場投入までの時間を減らす
リリース調整せずに、デプロイ変更リリースできることは企業の能力向上に寄与する
#### スケーリング
ボトルネックとなりうるサービスのみをスケーリングすることで、運用コストをコントロールできる
#### 堅牢性の向上
SaaS型など、シングルテナントからマルチテナントになると堅牢性の確保は非常に重要
マイクロサービスにすることで障害をサービスレベルにすることができる。
#### 開発効率を高める
人員を増加させた時、効率よくデリバリー速度を向上させるためには、相互作用がない独立した作業が多いほどよい。
#### 新しい技術を使う
サービスごとに採用する技術を変更することができ、モノリスと比べて制約を減らすことができる。

## マイクロサービスアーキテクチャを採用した際の課題と対応
### サービス間の連携
サービスが外部に自分の機能を公開する。その外部公開の契約を変更してしまうと、他のサービスに影響が出てしまう。
これはマイクロサービスの独立性を破壊するので、やらないし、対策が必要

対策としては、互換性のない変更を検出するツールやテストによるルール変更の検知

### 監視とトラブルシューティング
大量のサービスと大量のインスタンスが稼働している中で、障害をどのように検知し、どのように原因を調査していくのか。

対策としては、ログ集約システムを用いて、分散しているログを集約する。
トレーシング：一連の呼び出しがどこで失敗したのかを理解するため、フローに沿って、全体を確認するべき。
各処理をIDを通じてログを収集ることが重要。

### 多くのサービスを扱っている
サービス数やインスタンス数が多くなりすぎると、デプロイ・設定・管理するプロセスが増える。
結果として、デプロイ管理やトラブルシューティングに時間がかかり、サービス自体の開発時間が減少する。

対策として、デプロイやサービス運用を自動化することが挙げられる。
コンテナオーケストレーションやCICD環境を構築することである。

### エンド2エンドのテスト
マイクロサービスでは範囲が非常に広くなる。複数のサービスにまたがったテストとなるし、すべてのサービスをシナリオに沿って設定する必要がある。
インスタンスていしやネットワークタイムアウトという環境起因のテストも必要となる。

### DBの分割
各サービスがTBLの所有権を明確化して、特定のTBLについて、いろいろなサービスが書き込むような状況を避ける必要がある
ここに関しては根が深そうなので別機会で整理したい。