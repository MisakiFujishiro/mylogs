# API GateWay
[BlackBelt](https://pages.awscloud.com/rs/112-TZM-766/images/20190514_AWS-Blackbelt_APIGateway_rev.pdf)
はこちら
## API Gatewayとは
「Web API」の作成や公開、管理を行うためのフルマネージドサービス。  
サーバーレスのため、APIの実行基盤のサーバー構築や維持管理はAWSが責任を負う。

API Gatewayを利用することでRESTなWebAPIを作成、公開、管理することができる。



## API GatewayのAPIの種類
APIは3種類存在し、バックエンドのサービス、エンドポイントのタイプやCloudFrontが利用できるかなどの差がある   

APIの種類は３種類
- REST API
- HTTP API
- WebSocket API

バックエンドのサービスは5つ
- Lambda
- HTTPエンドポイント
- Mock
- AWS　サービス
- VPCリンク

エンドポイントのタイプは３種
- エッジ最適化APIエンドポイント（Cloud Front)
- プライベートAPIエンドポイント
- リージョンAPIエンドポイント

### APIで利用できる機能の差分について
RESTは古くからあって、HTTP APIはOIDCやOAuth対応など、最近の技術に対応している側面がある。

■認証認可  
OAuthやOIDCの認証認可はHTTPでしか利用できないが、Cognitoオーソライザは、WebSocketやRESTで利用できる。

■エッジ最適化  
エッジ最適化エンドポイントはRESTのみがサポートしている。




## API GWのデプロイとステージ
APIは`ステージ`という論理的な環境にデプロイされる。APIがデプロイされると以下の形式のエンドポイントURLが払い出される
> https://{api-id}.execute-api.{region}.amazonaws.com/{stageName}/...

`{stageName}`は好きに設定することができ、prd,stg,devのように定義する

![](img/apigw-stage.png)


## API GWの処理フロー
以下の４つの設定箇所で処理を設定することができる
- メソッドリクエスト
- 統合リクエスト
- 統合レスポンス
- メソッドレスポンス

![](img/apigw-flow.png)


## API GWのキャッシュ
API GWはステージごとにキャッシュを定義することができる。
キャッシュを更新した場合は、TTLを一時的に0にしたり、キャッシュをフラッシュすることで一時的にキャッシュを無効化する。

個別のリクエストがわでキャッシュを無効化したい場合は、Cache-Control:max-age=0を設定してリクエストする。


## API GWのAPIキーと使用量プラン
`APIキー`を発行することで、APIキーを持つユーザーのみがアクセス可能なAPIを作成することができる。

`使用量プラン`を作成することでAPIキーに対して、アクセス可能回数やアクセス頻度を設定することができる。

### 実装の流れ
[API GatewayのAPIキーと使用量プランについて](https://dev.classmethod.jp/articles/try-api-gateway-usage-plan/)
が参考になる。

実装の流れとしては以下のステップを踏む
1. APIGWでAPIの作成（APIキーを有効化）
2. APIキーの作成
3. 使用量プランの作成
4. 使用量プラン、APIのステージ、APIキーを関連づける


### スロットリング
API GWでは、流量制御の仕組みが実装されている。
流動制御により、過多なりクエストからAPIを守ったり、クライアントの使用量プランを作成できる。  

流動制御はスロットリングと呼ばれるトークンバケットアルゴリズムであり、1リクエストを処理するたびにバケットないのTokenが消費される。
サーバー側で設定する上限によりバックエンドを守ることができるとともに、クライアント側に設定することで使用量の制限をAPIキーとして設定することができる。

![](img/apigw_slot.png)



## API GWと認証認可
API GWにより、認証認可の仕組みを適用する場合い、いくつかの実現方法がある
1. IAMアクセス権限  
クライアントは、IAMユーザーのアクセスキーをハッシュ化した`AWS署名ver4`をリクエストヘッダーに付与する。
API GWで署名を検証して問題なければAPIを呼び出す。

2. Lambda オーソライザ  
クライアントがリクエストに認証情報を付与して、Lambdaで認証して、IAMポリシーを返却する。
API GWでポリシー評価をして問題なければAPIを呼び出す。

3. Cognito オーソライザ  
クライアントはCognitoで認証してJWTを発行してもらってJWTリクエストのヘッダーに付与する。
これは古くからあるRESTでも利用できる。

4. JWT オーソライザ(OAuth/OIDC)
クライアントはOIDCやOAuth2のプロバイダーでで認証してJWTを発行してもらってJWTリクエストのヘッダーに付与する。
これは最近できたHTTPのみでサポートされている。


## API GWの統合タイプ
全部で４つの統合タイプが準備されている。
実装時に、統合タイプとして、統合リソースのtypeを選択する
- Lambda関数：プロキシ統合であればtypeはAWS_PROXYX
- HTTP：HTTP_PROXYおよびHTTP
- Mock：MOCK
- AWSサービス：AWS
- VPCリンク：

![](img/apigw-tougoutype.png)

### Lambda関数との統合
プロキシ統合と非プロキシ統合がある。
- プロキシ統合：Lambdaからの返り値のフォーマットが固定
- 非プロキシ統合：フォーマットが決まっていないので、マッピングテンプレートを利用して、APIからの返り値を変更可能

指定するtypeについても、プロキシの場合はAWSではなくAWS_PROXYとなる点に注意

![](img/apigw-lambda_tougou.png)


#### マッピングテンプレート
統合リクエストや統合レスポンスで指定するテンプレートドキュメントで、データの形式を変換する

![](img/apigw-mapping.png)

### HTTPとの統合

![](img/apigw-http_tougou.png)


## APIGWの監視
CloudWatchでAPIGWを監視した際に取得できるメトリクスは以下
- 4XXError：指定された期間に取得されたクライアント側エラーの数。
- 5XXError：指定された期間に取得されたサーバー側エラーの数。
- CacheHitCount：指定された期間内に API キャッシュから配信されたリクエストの数。
- CacheMissCoun：API キャッシュが有効になっている特定の期間における、バックエンドから提供されたリクエストの数。
- Count：指定された期間内の API リクエストの合計数。
- IntegrationLatency：API Gateway がバックエンドにリクエストを中継してから、レスポンスを受け取るまでの時間。
- Latency：API Gateway がクライアントからリクエストを受け取ってから、クライアントにレスポンスを返すまでの時間。