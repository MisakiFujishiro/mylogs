
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>1. Code Series &#8212; my_sphinx  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/translations.js"></script>
    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="2. S3" href="S3.html" />
    <link rel="prev" title="1. 環境構築（MacOS）" href="../Docker/docker_env.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="S3.html" title="2. S3"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="../Docker/docker_env.html" title="1. 環境構築（MacOS）"
             accesskey="P">前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">my_sphinx  ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">1. </span>Code Series</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="code-series">
<h1><span class="section-number">1. </span>Code Series<a class="headerlink" href="#code-series" title="この見出しへのパーマリンク">¶</a></h1>
<p>ソースコードの反映をトリガーとして、ビルドデプロイといった一連のデリバリーを支援するサービス群<br />ソースコード管理サービスのCode Commit、ビルドサービスのCode Build、デプロイサービスのCode Deploy、これらの一連の処理を連携するデリバリーサービスのCodePipelineの総称</p>
<section id="code-commit">
<h2><span class="section-number">1.1. </span>Code Commit<a class="headerlink" href="#code-commit" title="この見出しへのパーマリンク">¶</a></h2>
<p>フルマネージドなソース管理（git repository）サービス<br />メリットとして、スケーラブルでセキュアであり、既存のgitツールともシームレスに連携</p>
<section id="id1">
<h3><span class="section-number">1.1.1. </span>設定手順<a class="headerlink" href="#id1" title="この見出しへのパーマリンク">¶</a></h3>
<p>基本的には、リポジトリ名を作成するだけ</p>
</section>
</section>
<section id="code-build">
<h2><span class="section-number">1.2. </span>Code Build<a class="headerlink" href="#code-build" title="この見出しへのパーマリンク">¶</a></h2>
<p>ソースコードをコンパイル・テスト実行して、デプロイ可能なSWパッケージを作成するフルマネージドなビルドサービス<br />メリットとして、ビルド用のサーバのプロビジョニング・管理が不要となる<br />codebuildの成果物はartifactと呼ばれる。格納するS3バケットを作成しておく</p>
<section id="id2">
<h3><span class="section-number">1.2.1. </span>設定手順<a class="headerlink" href="#id2" title="この見出しへのパーマリンク">¶</a></h3>
<ol class="simple">
<li><p>artifactの格納場所作成(S3のバケット作成</p></li>
<li><p>codebuildプロジェクトの設定</p>
<ul class="simple">
<li><p>ソースプロバイダの設定<br />ソースコードのプロバイダでリポジトリやブランチ・タグなどを設定する</p></li>
<li><p>buildの環境/ランタイムの設定する</p></li>
<li><p>アーティファクトの設定(S3で作成したバケットを指定)</p></li>
<li><p>ServiceRoleの設定<br /><code class="docutils literal notranslate"><span class="pre">AWSCodeDeployDeoloyerAccess</span></code>を付与する</p></li>
<li><p>buildspec.yamlの作成</p></li>
</ul>
</li>
</ol>
<p>フォルダ構成</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|-</span><span class="n">src</span>
<span class="o">|</span>  <span class="o">|---</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
<span class="o">|</span>
<span class="o">|-</span><span class="n">buidlspe</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>buildspec.ymlの記載項目</p>
<ul class="simple">
<li><p>version：buildspec.ymlファイルのバージョン指定0.2推奨</p></li>
<li><p>phases：ビルド実行時にCodeBuildが実行するコマンド</p>
<ul>
<li><p>install：インストール時にCodeBuildが実行</p></li>
<li><p>pre_build：ビルド前にCodeBuildが実行（ECRへの認証など）</p></li>
<li><p>build：ビルド実行中にCodeBuildが実行</p></li>
<li><p>post_build：ビルド後にCodeBuildが実行(ECRへのpushなど)</p></li>
</ul>
</li>
<li><p>artifacts：ビルドの出力結果の保存先</p>
<ul>
<li><p>files：必須項目でデプロイする成果物を指定<br />'**/*'を指定するとディレクトリは以下全てをデプロイする資産として指定</p></li>
<li><p>base-directory：デプロイ対象のルートディレクトリを指定</p></li>
</ul>
</li>
</ul>
<p>buildspec.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="mf">0.2</span>

<span class="n">phases</span><span class="p">:</span>
  <span class="n">build</span><span class="p">:</span>
    <span class="n">commands</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">aws</span> <span class="n">deploy</span> <span class="n">push</span> <span class="o">--</span><span class="n">application</span><span class="o">-</span><span class="n">name</span> <span class="p">[</span><span class="n">YOUT_CODEDEPLOY_APPLICATION_NAME</span><span class="p">]</span> <span class="o">--</span><span class="n">s3</span><span class="o">-</span><span class="n">location</span> <span class="n">s3</span><span class="p">:</span><span class="o">//</span><span class="p">[</span><span class="n">YOUR_BUCKT_NAME</span><span class="p">]</span><span class="o">/</span><span class="n">artifact</span><span class="o">.</span><span class="n">zip</span> <span class="o">--</span><span class="n">source</span> <span class="n">src</span>
<span class="n">artifacts</span><span class="p">:</span>
  <span class="n">files</span><span class="p">:</span>
    <span class="o">-</span> <span class="s1">&#39;**/*&#39;</span>
  <span class="n">base</span><span class="o">-</span><span class="n">directory</span><span class="p">:</span> <span class="n">src</span>
</pre></div>
</div>
</section>
</section>
<section id="code-deploy">
<h2><span class="section-number">1.3. </span>Code Deploy<a class="headerlink" href="#code-deploy" title="この見出しへのパーマリンク">¶</a></h2>
<p>EC2・Lambdaに対してデプロイを行うサービス<br />AutoScaling構成に対しても自動で反映してくれる</p>
<section id="id3">
<h3><span class="section-number">1.3.1. </span>設定手順<a class="headerlink" href="#id3" title="この見出しへのパーマリンク">¶</a></h3>
<ol class="simple">
<li><p>codeDeploy用のRoleを作成する<br />IAM&gt;ROLEの作成&gt;ユースケースとしてCodeDeployを選択</p></li>
<li><p>codeDeployのアプリケーション作成</p>
<ul class="simple">
<li><p>アプリケーション名やデプロイ先環境を設定（EC2/ECS/Lambda）</p></li>
</ul>
</li>
<li><p>deploy Groupの作成</p>
<ul class="simple">
<li><p>事前に設定したサービスロールを選択</p></li>
<li><p>環境設定でデプロイ対象を選ぶ（ターゲットグループやタグで対象を絞れる）</p></li>
</ul>
</li>
<li><p>appspec.ymlの作成</p></li>
</ol>
<p>フォルダ構成</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|-</span><span class="n">src</span>
<span class="o">|</span>  <span class="o">|---</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
<span class="o">|</span>  <span class="o">|---</span><span class="n">appspec</span><span class="o">.</span><span class="n">yml</span>
<span class="o">|</span>
<span class="o">|-</span><span class="n">buidlspe</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>appspec.ymlの記載項目</p>
<ul class="simple">
<li><p>version：0.0のみ</p></li>
<li><p>os：linux or Windows</p></li>
<li><p>files：ビルドした結果をどこに配置するかの設定</p></li>
<li><p>hook：インストール前後の処理</p></li>
</ul>
<p>buildspec.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="mf">0.0</span>
<span class="n">os</span><span class="p">:</span> <span class="n">linux</span>
<span class="n">files</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">source</span><span class="p">:</span> <span class="n">index</span><span class="o">.</span><span class="n">html</span>
    <span class="n">destination</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span>
</pre></div>
</div>
</section>
</section>
<section id="code-pipeline">
<h2><span class="section-number">1.4. </span>Code Pipeline<a class="headerlink" href="#code-pipeline" title="この見出しへのパーマリンク">¶</a></h2>
<p>フルマネージドな継続的デリバリーサービス<br />ソースコードの変更をトリガーとして、ビルド・デプロイといった一連の流れを自動的に実行する</p>
<section id="id4">
<h3><span class="section-number">1.4.1. </span>設定手順<a class="headerlink" href="#id4" title="この見出しへのパーマリンク">¶</a></h3>
<ol class="simple">
<li><p>パイプライン名称<br />パイプラインの構成を考慮の上セッティング</p></li>
<li><p>ソースステージ設定<br />CodeCommitとの連携を設定し、検知するリポジトリやブランチ名を設定する</p></li>
</ol>
<p><img alt="../_images/codepipelene_setting.png" src="../_images/codepipelene_setting.png" /></p>
<ol class="simple">
<li><p>ビルドステージ設定</p>
<ul class="simple">
<li><p>デプロイプロバイダーにCodeBuild</p></li>
<li><p>設定済のアプリケーションやデプロイグループを選択</p></li>
</ul>
</li>
<li><p>デプロイステージ設定<br />デプロイ先を設定する。 S3への直接デプロイや、ECS/EC2へのデプロイが可能</p></li>
</ol>
</section>
<section id="s3cicd">
<h3><span class="section-number">1.4.2. </span>S3へのCICD<a class="headerlink" href="#s3cicd" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>ビルドステージはスキップ</p></li>
<li><p>デプロイステージでプロバイダーでS3を設定して、リージョンやバケットを選択</p></li>
</ul>
</section>
<section id="ec2cicd">
<h3><span class="section-number">1.4.3. </span>EC2へのCICD<a class="headerlink" href="#ec2cicd" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>EC2の作成
タグ名でCICDの対象を設定できるので、タグ名を設定しておくと良い</p></li>
<li><p>EC2にcode deploy エージェントをインストールしておく<br /><a class="reference external" href="https://docs.aws.amazon.com/ja_jp/codedeploy/latest/userguide/codedeploy-agent-operations-install.html">AWS Code Deploy エージェント</a>のコマンドラインからのインストールを実行</p></li>
</ul>
<blockquote>
<div><p>wget https://aws-codedeploy-ap-northeast-1.s3.ap-northeast-1.amazonaws.com/latest/install</p>
</div></blockquote>
<section id="codebuild">
<h4><span class="section-number">1.4.3.1. </span>トラブルシューティング:codeBuildを手動で実行するとエラー<a class="headerlink" href="#codebuild" title="この見出しへのパーマリンク">¶</a></h4>
<blockquote>
<div><p>[Container] 2022/10/23 13:46:20 Phase context status code: COMMAND_EXECUTION_ERROR Message: Error while executing command: aws deploy push --application-name h4b-cicd-codedeploy-application --s3-location s3://h4b-cicd-artifact-fujisiroms/artifact.zip --source src. Reason: exit status 255</p>
</div></blockquote>
<p>appspec.ymlがsrcディレクトリは以下になかったことが原因</p>
</section>
<section id="codedeploy">
<h4><span class="section-number">1.4.3.2. </span>トラブルシューティング:codeDeployを手動で実行するとエラー<a class="headerlink" href="#codedeploy" title="この見出しへのパーマリンク">¶</a></h4>
<blockquote>
<div><p>The overall deployment failed because too many individual instances failed deployment, too few healthy instances are available for deployment, or some instances in your deployment group are experiencing problems.</p>
</div></blockquote>
<p>appspec.ymlの文法がミスったまま、Deployしていたのが原因。appspec.ymlを修正してからbuildとdeployを実行</p>
</section>
</section>
</section>
<section id="githubcodecommit">
<h2><span class="section-number">1.5. </span>githubとCodeCommitのミラーリング<a class="headerlink" href="#githubcodecommit" title="この見出しへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><p>公開鍵・秘密鍵の作成<br />LocalPCで以下を実行</p></li>
</ul>
<blockquote>
<div><p>ssh-keygen -t rsa -b 4096 -m PEM -C &lt;メールアドレス&gt;</p>
</div></blockquote>
<p>作成された公開鍵と秘密鍵は以下コマンドでクリップボードにコピーすると扱いやすい</p>
<blockquote>
<div><p>pbcopy &lt; ~/.ssh/id_rsa.pub</p>
</div></blockquote>
<blockquote>
<div><p>pbcopy &lt; ~/.ssh/id_rsa</p>
</div></blockquote>
<ul class="simple">
<li><p>IAMユーザーに公開鍵を紐づける<br />IAM&gt;アクセス管理&gt;ユーザー&gt;AWS CodeCommitのSSHキーにパブリックキーをアップロード<br />SSHキーの<code class="docutils literal notranslate"><span class="pre">ID</span></code>をメモしておく</p></li>
</ul>
<p><img alt="../_images/codecommit_iam_setting.png" src="../_images/codecommit_iam_setting.png" /></p>
<ul class="simple">
<li><p>githubに秘密鍵をSecretes登録<br />github&gt;Setting&gt;Secrets&gt;Actions&gt;New repository secrets<br />以下の情報を登録</p>
<ul>
<li><p>秘密鍵</p>
<ul>
<li><p>Name:CODECOMMIT_SSH_PRIVATE_KEY</p></li>
<li><p>Value:プライベートキーの中身</p></li>
</ul>
</li>
<li><p>SSHキーID</p>
<ul>
<li><p>Name：CODECOMMIT_SSH_PRIVATE_KEY_ID</p></li>
<li><p>Value：SSHキーのID</p></li>
</ul>
</li>
</ul>
</li>
<li><p>githubとgitcommitを紐づける<br />github&gt;Actions&gt;New Work Flow&gt;set up a workflow</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>name: Mirroring

on: [ push, delete ]

jobs:
  to_codecommit:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v1
      - uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url:
            ssh://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/[YOUR REPOSITORY NAME]
          ssh_private_key:
            ${{ secrets.CODECOMMIT_SSH_PRIVATE_KEY }}
          ssh_username:
            ${{ secrets.CODECOMMIT_SSH_PRIVATE_KEY_ID }}
</pre></div>
</div>
<ul class="simple">
<li><p>動作確認<br />localにgithubのリポジトリをcloneして、新しいブランチを作ったり、ファイル編集してから、gitpushすると、codeCommitにまで反映されている</p></li>
</ul>
</section>
<section id="references">
<h2><span class="section-number">1.6. </span>References<a class="headerlink" href="#references" title="この見出しへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://chibinfra-techblog.com/github-with-aws-codecommit/">GitHubをCodeCommitにミラーリングする</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/s_ryota/items/803b44caacac12fd2439">buildspec.ymlコマンド</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/leomaro7/items/1eca2b814930f98f3ff9">Codebuild の buildspec.yaml</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/leomaro7/items/40f126a4f0c23d511e88">Codedeploy の 概要や appspec.yaml</a></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">1. Code Series</a><ul>
<li><a class="reference internal" href="#code-commit">1.1. Code Commit</a><ul>
<li><a class="reference internal" href="#id1">1.1.1. 設定手順</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code-build">1.2. Code Build</a><ul>
<li><a class="reference internal" href="#id2">1.2.1. 設定手順</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code-deploy">1.3. Code Deploy</a><ul>
<li><a class="reference internal" href="#id3">1.3.1. 設定手順</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code-pipeline">1.4. Code Pipeline</a><ul>
<li><a class="reference internal" href="#id4">1.4.1. 設定手順</a></li>
<li><a class="reference internal" href="#s3cicd">1.4.2. S3へのCICD</a></li>
<li><a class="reference internal" href="#ec2cicd">1.4.3. EC2へのCICD</a><ul>
<li><a class="reference internal" href="#codebuild">1.4.3.1. トラブルシューティング:codeBuildを手動で実行するとエラー</a></li>
<li><a class="reference internal" href="#codedeploy">1.4.3.2. トラブルシューティング:codeDeployを手動で実行するとエラー</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#githubcodecommit">1.5. githubとCodeCommitのミラーリング</a></li>
<li><a class="reference internal" href="#references">1.6. References</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="../Docker/docker_env.html"
                          title="前の章へ"><span class="section-number">1. </span>環境構築（MacOS）</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="S3.html"
                          title="次の章へ"><span class="section-number">2. </span>S3</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/AWS/CodeSeries.md.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="S3.html" title="2. S3"
             >次へ</a> |</li>
        <li class="right" >
          <a href="../Docker/docker_env.html" title="1. 環境構築（MacOS）"
             >前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">my_sphinx  ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">1. </span>Code Series</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, sphinx_user.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.2.3.
    </div>
  </body>
</html>