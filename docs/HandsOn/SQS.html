
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>2. SQSのチュートリアル実装(CLI編) &#8212; my_sphinx  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/translations.js"></script>
    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="5. MSKのチュートリアル実装(CLI編)" href="MSK.html" />
    <link rel="prev" title="1. CodePipelineを利用してCFNのCICD環境を作成する" href="cloudformaiton_CICD.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="MSK.html" title="5. MSKのチュートリアル実装(CLI編)"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="cloudformaiton_CICD.html" title="1. CodePipelineを利用してCFNのCICD環境を作成する"
             accesskey="P">前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">my_sphinx  ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">2. </span>SQSのチュートリアル実装(CLI編)</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="sqs-cli">
<h1><span class="section-number">2. </span>SQSのチュートリアル実装(CLI編)<a class="headerlink" href="#sqs-cli" title="この見出しへのパーマリンク">¶</a></h1>
<p>以下の内容に関して理解するためにチュートリアルを行う</p>
<ul class="simple">
<li><p>キューの作り方</p></li>
<li><p>DLTの設定方法</p></li>
<li><p>メッセージの送受信方法</p></li>
</ul>
<p>参考にしたサイト</p>
<ul class="simple">
<li><p><a class="reference external" href="https://weblabo.oscasierra.net/aws-sqs-tutorial/">CLIで作成・送受信</a></p></li>
</ul>
<section id="id1">
<h2><span class="section-number">2.1. </span>キューの作り方<a class="headerlink" href="#id1" title="この見出しへのパーマリンク">¶</a></h2>
<p>SQSのキューの作成方法について整理する</p>
<section id="cli">
<h3><span class="section-number">2.1.1. </span>CLIで作成する場合<a class="headerlink" href="#cli" title="この見出しへのパーマリンク">¶</a></h3>
<p>まずは、キューが存在するかの確認。以下コマンドで、現在のキューを確認できる。何もない場合は返値なし</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs list-queues
</pre></div>
</div>
<p>キューの作成はcreate-queueコマンド（以下は標準キューを作成する場合）</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs create-queue --queue-name [YOUR_QUEUE_NAME]
{
    &quot;QueueUrl&quot;: &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot;
}
</pre></div>
</div>
<p>FIFOキューを作成する場合は、キュー名の最後に<code class="docutils literal notranslate"><span class="pre">.fifo</span></code>を追加して、FifoQueue=Trueのオプションを追加する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs create-queue --queue-name [YOUR_QUEUE_NAME].fifo --attributes FifoQueue=true
</pre></div>
</div>
<p>改めて、キューの確認を行うと作成したキューが確認できる</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs list-queues
{
    &quot;QueueUrls&quot;: [
        &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot;
    ]
}
</pre></div>
</div>
<p>また、作成したキューについての詳細を<code class="docutils literal notranslate"><span class="pre">get-queue-attributes</span></code>で表示させることができる</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs get-queue-attributes --attribute-names All --queue-url https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME] 

{
    &quot;Attributes&quot;: {
        &quot;QueueArn&quot;: &quot;arn:aws:sqs:ap-northeast-1:[AWS_ACCOUNT_ID]:[YOUR_QUEUE_NAME]&quot;,
        &quot;ApproximateNumberOfMessages&quot;: &quot;0&quot;,
        &quot;ApproximateNumberOfMessagesNotVisible&quot;: &quot;0&quot;,
        &quot;ApproximateNumberOfMessagesDelayed&quot;: &quot;0&quot;,
        &quot;CreatedTimestamp&quot;: &quot;1683331260&quot;,
        &quot;LastModifiedTimestamp&quot;: &quot;1683331260&quot;,
        &quot;VisibilityTimeout&quot;: &quot;30&quot;,
        &quot;MaximumMessageSize&quot;: &quot;262144&quot;,
        &quot;MessageRetentionPeriod&quot;: &quot;345600&quot;,
        &quot;DelaySeconds&quot;: &quot;0&quot;,
        &quot;ReceiveMessageWaitTimeSeconds&quot;: &quot;0&quot;,
        &quot;SqsManagedSseEnabled&quot;: &quot;true&quot;
    }
}
</pre></div>
</div>
<p>得られる属性値のうち、キューの状態を表すものは以下</p>
<ul class="simple">
<li><p>ApproximateNumberOfMessages<br />未処理のメッセージの数</p></li>
<li><p>ApproximateNumberOfMessagesNotVisible<br />Consumerが取得したが、処理完了していないメッセージ数（処理中のメッセージ数）</p></li>
<li><p>ApproximateNumberOfMessagesDelayed<br />遅延時間が設定されているメッセージ数（Consumer処理可能になるまで待機しているメッセージ数）</p></li>
</ul>
<p>得られる属性値のうち、キューの設定値を表すものは以下</p>
<ul class="simple">
<li><p>VisibilityTimeout<br />可視性タイムアウト（他のConsumerにメッセージが見えるようになるまでの時間）</p></li>
<li><p>DelaySeconds<br />遅延時間（受信してから、Consumerがメッセージが見えるようになるまでの時間）<br />この遅延時間はキュー全体に対して適用される。</p></li>
<li><p>ReceiveMessageWaitTimeSeconds<br />メッセージがポーリングされる際の最大待機時間</p></li>
<li><p>MessageRetentionPeriod<br />メッセージが保管される期間</p></li>
</ul>
<p>コンソールから確認すると以下</p>
<p><img alt="../_images/sqs_setting.png" src="../_images/sqs_setting.png" /></p>
</section>
<section id="gui">
<h3><span class="section-number">2.1.2. </span>GUIで作成する場合<a class="headerlink" href="#gui" title="この見出しへのパーマリンク">¶</a></h3>
<p>キュータイプと名前を指定する</p>
<p><img alt="../_images/sqs_setting_manual1.png" src="../_images/sqs_setting_manual1.png" /></p>
<p>キューに対する遅延時間や可視性タイムアウトを設定する</p>
<p><img alt="../_images/sqs_setting_manual2.png" src="../_images/sqs_setting_manual2.png" /></p>
<p>暗号化とアクセスポリシーを設定する</p>
<p><img alt="../_images/sqs_setting_manual3.png" src="../_images/sqs_setting_manual3.png" /></p>
</section>
</section>
<section id="dlt">
<h2><span class="section-number">2.2. </span>DLTの設定方法<a class="headerlink" href="#dlt" title="この見出しへのパーマリンク">¶</a></h2>
<p>CLIから作成する場合は、<code class="docutils literal notranslate"><span class="pre">RedrivePolicy</span></code>をオプションとして指定することで作成することができるが、詳細は<a class="reference external" href="https://docs.aws.amazon.com/cli/latest/reference/sqs/create-queue.html">公式ドキュメント</a>を参照されたい。</p>
<p>コンソール画面からは、キューを作成や更新する際に指定することができる。注意点として、DLQは送信元のキューと同じキュータイプ（標準・FIFO）を設定する必要がある。</p>
<p><img alt="../_images/sqs_dlq_setting.png" src="../_images/sqs_dlq_setting.png" /></p>
<p>最大受信数に設定した回数、、キューが失敗した場合にDLQに送信される。</p>
</section>
<section id="id2">
<h2><span class="section-number">2.3. </span>メッセージの送受信方法<a class="headerlink" href="#id2" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id3">
<h3><span class="section-number">2.3.1. </span>CLIで送信<a class="headerlink" href="#id3" title="この見出しへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">send-message</span></code>を利用してメッセージを送信するとメッセージIDとメッセージのハッシュが返却される</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sqs</span> <span class="n">send</span><span class="o">-</span><span class="n">message</span> <span class="o">--</span><span class="n">queue</span><span class="o">-</span><span class="n">url</span> <span class="s2">&quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot;</span> <span class="o">--</span><span class="n">message</span><span class="o">-</span><span class="n">body</span> <span class="s2">&quot;hello world&quot;</span>
<span class="p">{</span>
    <span class="s2">&quot;MD5OfMessageBody&quot;</span><span class="p">:</span> <span class="s2">&quot;5eb63bbbe01eeed093cb22bb8f5acdc3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MessageId&quot;</span><span class="p">:</span> <span class="s2">&quot;1db7869e-5ca0-4e97-810c-bb7b7b7522bc&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3><span class="section-number">2.3.2. </span>コンソールから送信<a class="headerlink" href="#id4" title="この見出しへのパーマリンク">¶</a></h3>
<p>SQSのコンソールから、キューを選択しメッセージを送受信を選択</p>
<p><img alt="../_images/sqs_txrx_console.png" src="../_images/sqs_txrx_console.png" /></p>
<p>メッセージを送信タブから、メッセージ本文を記載して送信する</p>
<p><img alt="../_images/sqs_tx_console.png" src="../_images/sqs_tx_console.png" /></p>
</section>
<section id="id5">
<h3><span class="section-number">2.3.3. </span>送信の確認<a class="headerlink" href="#id5" title="この見出しへのパーマリンク">¶</a></h3>
<p>CLIから<code class="docutils literal notranslate"><span class="pre">ApproximateNumberOfMessages</span></code>を確認する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs get-queue-attributes --attribute-names ApproximateNumberOfMessages  --queue-url &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot; 
{
    &quot;Attributes&quot;: {
        &quot;ApproximateNumberOfMessages&quot;: &quot;2&quot;
    }
}
</pre></div>
</div>
<p>もしくは、コンソールから<code class="docutils literal notranslate"><span class="pre">利用可能なメッセージ</span></code>を確認する</p>
<p><img alt="../_images/sqs_message_num.png" src="../_images/sqs_message_num.png" /></p>
</section>
<section id="id6">
<h3><span class="section-number">2.3.4. </span>コンソールで受信確認<a class="headerlink" href="#id6" title="この見出しへのパーマリンク">¶</a></h3>
<p>まず、コンソールからキュー内のメッセージを受信することができる。
注意点は、SQSはメッセージを受信しただけではなく、削除までする必要があるので、このオペレーションを繰り返すと、受信回数が増えてDLQに移動してしまうこと。</p>
<p>SQSのコンソールから、キューを選択しメッセージを送受信を選択</p>
<p><img alt="../_images/sqs_txrx_console.png" src="../_images/sqs_txrx_console.png" /></p>
<p>メッセージを受信タブから、メッセージをポーリングする</p>
<p><img alt="../_images/sqs_rx_console1.png" src="../_images/sqs_rx_console1.png" /></p>
<p>ポーリングの結果得られたメッセージを押下すると、本文などが確認できる。</p>
<p><img alt="../_images/sqs_rx_console2.png" src="../_images/sqs_rx_console2.png" /></p>
<p>ポーリングをDLQで設定した回数分行うとDLQに移動する</p>
</section>
<section id="id7">
<h3><span class="section-number">2.3.5. </span>CLIでメッセージ受信と削除<a class="headerlink" href="#id7" title="この見出しへのパーマリンク">¶</a></h3>
<p>次に、メッセージをコンソールから受信し、その上で削除を行う。</p>
<p>メッセージの受信は<code class="docutils literal notranslate"><span class="pre">receive-message</span></code>を利用する。メッセージは複数格納されていても、1つのメッセージだけが受信される</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs receive-message --queue-url &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot; 
{
    &quot;Messages&quot;: [
        {
            &quot;MessageId&quot;: &quot;698a7959-7d80-4125-9ccf-2a1a52334606&quot;,
            &quot;ReceiptHandle&quot;: &quot;AQEBQfRoUCKb74uFFlmZT~~~~&quot;,
            &quot;MD5OfBody&quot;: &quot;11b1d675d840f10f85fed95d4af7264a&quot;,
            &quot;Body&quot;: &quot;message_from_console1&quot;
        }
    ]
}
</pre></div>
</div>
<p>SQSではメッセージの処理が完了したら、明示的にメッセージの削除を行う必要がある。
メッセージの削除は<code class="docutils literal notranslate"><span class="pre">delete-message</span></code>を利用する。また、メッセージを指定するために受信した際に受け取った`ReceiptHandle&quot;を指定して削除するメッセージを決める</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs delete-message --queue-url &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot; --receipt-handle &quot;AQEBQfRoUCKb74uFFlmZT~~~~&quot;
</pre></div>
</div>
<p>削除されたことで、メッセージキューにも、DLQにもメッセージが存在しないことが確認できる。</p>
</section>
</section>
</section>
<section id="sqs-java">
<h1><span class="section-number">3. </span>SQSのチュートリアル実装(Java編)<a class="headerlink" href="#sqs-java" title="この見出しへのパーマリンク">¶</a></h1>
<p>参考サイト</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.stsd.co.jp/dev-blog/send_and_receive_amazon_sqs_messages_from_java.html">JavaからAmazon SQSのメッセージ送受信を行う</a></p></li>
<li><p><a class="reference external" href="https://weblabo.oscasierra.net/aws-sqs-tutorial-java-1/">JavaでAmazon SQSのメッセージを送受信するチュートリアル</a></p></li>
</ul>
<section id="sqs">
<h2><span class="section-number">3.1. </span>SQSの作成<a class="headerlink" href="#sqs" title="この見出しへのパーマリンク">¶</a></h2>
<p>SQSは別資料で作成した標準キューを再利用する</p>
</section>
<section id="ec2">
<h2><span class="section-number">3.2. </span>EC2の作成<a class="headerlink" href="#ec2" title="この見出しへのパーマリンク">¶</a></h2>
<p>基本的にはデフォルトでEC2を作成。</p>
<p>IAMについては以下のポリシーを持つIAMポリシーを作成しておき付与する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;VisualEditor0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;sqs:DeleteMessage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sqs:ReceiveMessage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sqs:SendMessage&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:sqs:ap-northeast-1:[アカウントID]:[SQS_NAME]&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="java-producer">
<h2><span class="section-number">3.3. </span>Javaのプログラム作成（Producer<a class="headerlink" href="#java-producer" title="この見出しへのパーマリンク">¶</a></h2>
<p>JavaからSQSへのアクセスには、AWS公式のライブラリ<code class="docutils literal notranslate"><span class="pre">aws-java-sdk-sqs</span></code>を利用することとする。pomに以下を追加する。</p>
<p>pom.xml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="o">.</span><span class="n">amazonaws</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">aws</span><span class="o">-</span><span class="n">java</span><span class="o">-</span><span class="n">sdk</span><span class="o">-</span><span class="n">sqs</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">1.12.116</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
<section id="config">
<h3><span class="section-number">3.3.1. </span>config<a class="headerlink" href="#config" title="この見出しへのパーマリンク">¶</a></h3>
<p>src/main/javaの配下にconfigのディレクトリを作成して、<code class="docutils literal notranslate"><span class="pre">sqsConfig</span></code>を作成する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_producer</span><span class="o">.</span><span class="n">config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.AmazonSQS</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.AmazonSQSClientBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>

<span class="nd">@Configuration</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">sqsConfig</span> <span class="p">{</span>
    <span class="nd">@Bean</span>
    <span class="n">public</span> <span class="n">AmazonSQS</span> <span class="n">amazonSQSClient</span><span class="p">(){</span>
        <span class="k">return</span> <span class="n">AmazonSQSClientBuilder</span><span class="o">.</span><span class="n">defaultClient</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>&#64;configurationにより、設定クラスであることを宣言</p>
<ul>
<li><p>設定クラスではSpringがDIするためのBeanの定義を行う</p></li>
</ul>
</li>
<li><p>&#64;Beanにより、メソッドがDIコンテナによって管理させるBeanを作成することを宣言</p>
<ul>
<li><p>AmazonSQSClient()メソッドにより、SQSのクライアントを生成する</p></li>
<li><p>defaultClient() メソッドは、既定の設定を使用して AmazonSQS クライアントのインスタンスを作成します。</p></li>
</ul>
</li>
</ul>
</section>
<section id="messagesender">
<h3><span class="section-number">3.3.2. </span>MessageSender<a class="headerlink" href="#messagesender" title="この見出しへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_producer</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.AmazonSQS</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.model.SendMessageRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="nd">@Component</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">MessageSender</span> <span class="p">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">private</span> <span class="n">AmazonSQS</span> <span class="n">amazonSQSClient</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">sendMessage</span><span class="p">(){</span>
        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://sqs.ap-northeast-1.amazonaws.com/626394096352/MA-fujishiroms-sqs-standard&quot;</span><span class="p">;</span>

        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;hello SQS!! FROM JAVA&quot;</span><span class="p">;</span>

        <span class="n">SendMessageRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SendMessageRequest</span><span class="p">()</span>
                <span class="o">.</span><span class="n">withQueueUrl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="o">.</span><span class="n">withMessageBody</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="o">.</span><span class="n">withDelaySeconds</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="n">amazonSQSClient</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ここで指定している<code class="docutils literal notranslate"><span class="pre">withDelaySeconds</span></code>はメッセージに対する遅延時間。
SQSのコンソール画面から設定した、<code class="docutils literal notranslate"><span class="pre">DelaySeconds</span></code>はキュー全体に対する遅延時間。</p>
</section>
<section id="main">
<h3><span class="section-number">3.3.3. </span>main<a class="headerlink" href="#main" title="この見出しへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_producer</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="p">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">SqsProducerApplication</span> <span class="p">{</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SpringApplication</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">SqsProducerApplication</span><span class="o">.</span><span class="n">class</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="n">MessageSender</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getBean</span><span class="p">(</span><span class="n">MessageSender</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>
        <span class="n">sender</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="java-consumer">
<h2><span class="section-number">3.4. </span>Javaのプログラム作成（Consumer<a class="headerlink" href="#java-consumer" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id8">
<h3><span class="section-number">3.4.1. </span>Config<a class="headerlink" href="#id8" title="この見出しへのパーマリンク">¶</a></h3>
<p>&#64;Configurationがついているクラスなので、設定クラスとしてSpringに認識される。<br />この設定クラスは以下で、&#64;Beanを付与することで、対象クラスの返り値オブジェクトがSpringフレームワークの管理下に置かれることになる。</p>
<p>AmaozonSQSClientBuilderを利用して、SQSのデフォルトのクライアントインスタンスを作成している。
一旦デフォルト値を使用して、SQSのクライアントに対して、認証情報やリージョンの情報を渡している。
メッセージに関する詳細なやりとりに関しては別で実装する。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">sqsConfig</span> <span class="p">{</span>
    <span class="nd">@Bean</span>
    <span class="n">public</span> <span class="n">AmazonSQS</span> <span class="n">amazonSQSClient</span><span class="p">(){</span>
        <span class="k">return</span> <span class="n">AmazonSQSClientBuilder</span><span class="o">.</span><span class="n">defaultClient</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="messagereceiver">
<h3><span class="section-number">3.4.2. </span>MessageReceiver<a class="headerlink" href="#messagereceiver" title="この見出しへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_consumer</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.AmazonSQS</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.model.Message</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.model.ReceiveMessageRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.model.ReceiveMessageResult</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="nd">@Component</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">MessageReceiver</span> <span class="p">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">private</span> <span class="n">AmazonSQS</span> <span class="n">amazonSQSClient</span><span class="p">;</span>


    <span class="n">public</span> <span class="n">void</span> <span class="n">receiveMessage</span><span class="p">(){</span>
    <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://sqs.ap-northeast-1.amazonaws.com/626394096352/MA-fujishiroms-sqs-standard&quot;</span><span class="p">;</span>

    <span class="n">ReceiveMessageRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ReceiveMessageRequest</span><span class="p">()</span>
                <span class="o">.</span><span class="n">withQueueUrl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="o">.</span><span class="n">withWaitTimeSeconds</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="o">.</span><span class="n">withMaxNumberOfMessages</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

    <span class="n">ReceiveMessageResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">amazonSQSClient</span><span class="o">.</span><span class="n">receiveMessage</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">Message</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">getMessages</span><span class="p">())</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">受信したメッセージの情報を表示</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="o">+</span><span class="n">msg</span><span class="o">.</span><span class="n">getMessageId</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">);</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;  Message ID     : &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">getMessageId</span><span class="p">());</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;  Receipt Handle : &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">getReceiptHandle</span><span class="p">());</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;  Message Body   : &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">getBody</span><span class="p">());</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">();</span>

        <span class="o">//</span> <span class="n">受信したメッセージを削除</span>
        <span class="n">amazonSQSClient</span><span class="o">.</span><span class="n">deleteMessage</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">getReceiptHandle</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="frontend">
<h3><span class="section-number">3.4.3. </span>frontend<a class="headerlink" href="#frontend" title="この見出しへのパーマリンク">¶</a></h3>
<p>ECSに載せるための動作確認用とhelthcheck用に文字列を返すControllerを作成しておく</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_consumer</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">frontendController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;/sqs-consumer&quot;</span><span class="p">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">)</span>
    <span class="n">public</span> <span class="n">String</span> <span class="n">frontend</span><span class="p">(){</span>
        <span class="k">return</span> <span class="s2">&quot;Hello sqs-consumer!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3><span class="section-number">3.4.4. </span>main<a class="headerlink" href="#id9" title="この見出しへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_consumer</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="p">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">SqsConsumerApplication</span> <span class="p">{</span>

	<span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SpringApplication</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">SqsConsumerApplication</span><span class="o">.</span><span class="n">class</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="n">MessageReceiver</span> <span class="n">receiver</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getBean</span><span class="p">(</span><span class="n">MessageReceiver</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>
		<span class="n">receiver</span><span class="o">.</span><span class="n">receiveMessage</span><span class="p">();</span>

	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id10">
<h2><span class="section-number">3.5. </span>EC2からの実行<a class="headerlink" href="#id10" title="この見出しへのパーマリンク">¶</a></h2>
<section id="jar">
<h3><span class="section-number">3.5.1. </span>jarファイルを移動させる<a class="headerlink" href="#jar" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>キーペアのコピー</p>
<ul>
<li><p>作成した、キーペアをworkspacesにコピーしておく（ファイルのコピーはできないので、テキストベースでコピーする。</p></li>
</ul>
</li>
<li><p>権限付与</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="mi">600</span> <span class="n">XXXX</span><span class="o">.</span><span class="n">pem</span> 
</pre></div>
</div>
<ul class="simple">
<li><p>ファイルコピーコマンド実行</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;EC2秘密鍵&#39;</span> <span class="s1">&#39;ローカルの転送したいファイル&#39;</span> <span class="s1">&#39;EC2ユーザー名@IPアドレス:ファイル配置先 </span>

<span class="n">EX</span><span class="p">)</span><span class="n">scp</span> <span class="o">-</span><span class="n">i</span> <span class="o">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">XXX</span><span class="o">.</span><span class="n">pem</span> <span class="n">TEST</span><span class="o">.</span><span class="n">txt</span> <span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">@</span><span class="mf">12.34.567.890</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span>
</pre></div>
</div>
</section>
<section id="java">
<h3><span class="section-number">3.5.2. </span>javaのインストール<a class="headerlink" href="#java" title="この見出しへのパーマリンク">¶</a></h3>
<p>EC2にjavaをインストールして、jarファイルを実行する</p>
<p>javaのインストール</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">java</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="n">amazon</span><span class="o">-</span><span class="n">corretto</span>
</pre></div>
</div>
<p>実行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">XXX</span><span class="o">.</span><span class="n">jar</span>
</pre></div>
</div>
</section>
<section id="id11">
<h3><span class="section-number">3.5.3. </span>結果<a class="headerlink" href="#id11" title="この見出しへのパーマリンク">¶</a></h3>
<p>Producer側のjarファイルを実行</p>
<p><img alt="../_images/sqs_tutorial_producer.png" src="../_images/sqs_tutorial_producer.png" /></p>
<p>Consumer側のjarファイルを実行すると、メッセージを取得することができる</p>
<p><img alt="../_images/sqs_tutorial_consumer.png" src="../_images/sqs_tutorial_consumer.png" /></p>
<p>CloudWatchでApproximateNumberOfMessagesVisibleを確認するとConsumer側ではメッセージを削除するので、Produceした分増えた後、Consumeした分減る</p>
<p><img alt="../_images/sqs_tutorial_metrix.png" src="../_images/sqs_tutorial_metrix.png" /></p>
</section>
</section>
</section>
<section id="id12">
<h1><span class="section-number">4. </span>SQSの開発環境構築<a class="headerlink" href="#id12" title="この見出しへのパーマリンク">¶</a></h1>
<section id="producercicd">
<h2><span class="section-number">4.1. </span>ProducerのCICD<a class="headerlink" href="#producercicd" title="この見出しへのパーマリンク">¶</a></h2>
<p>Producer側はバッチで処理を流すので、CodeDeployでEC2上にjarファイルをデプロイする</p>
<ol class="simple">
<li><p><a class="reference external" href="https://misakifujishiro.github.io/mylogs/Java/intelliJ.html#intellijgithub">IntelliJとGithubを連携</a></p></li>
<li><p><a class="reference external" href="https://misakifujishiro.github.io/mylogs/AWS/CodeSeries.html#code-commit">GithubとCodeCommitのミラーリング</a></p></li>
<li><p>CodeDeoloyの準備</p></li>
<li><p>CodeDeployの設定</p></li>
<li><p>CodePipelineの作成</p></li>
</ol>
<section id="codedeploy">
<h3><span class="section-number">4.1.1. </span>CodeDeployの準備<a class="headerlink" href="#codedeploy" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>appspec.ymlをJava PJのルートディレクトリに配置する</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="mf">0.0</span>
<span class="n">os</span><span class="p">:</span> <span class="n">linux</span>
<span class="n">files</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">source</span><span class="p">:</span> <span class="n">target</span><span class="o">/</span><span class="n">sqs_producer</span><span class="o">-</span><span class="mf">0.0.1</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">.</span><span class="n">jar</span>
    <span class="n">destination</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">/</span>
<span class="n">permissions</span><span class="p">:</span>
  <span class="o">-</span> <span class="nb">object</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">/</span><span class="n">sqs_producer</span><span class="o">-</span><span class="mf">0.0.1</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">.</span><span class="n">jar</span>
    <span class="n">mode</span><span class="p">:</span> <span class="mi">755</span>
</pre></div>
</div>
<ul class="simple">
<li><p>EC2にcodedeployエージェントをインストール</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">ruby</span>
<span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">aws</span><span class="o">-</span><span class="n">cli</span>
<span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">aws</span><span class="o">-</span><span class="n">codedeploy</span><span class="o">-</span><span class="n">ap</span><span class="o">-</span><span class="n">northeast</span><span class="o">-</span><span class="mf">1.</span><span class="n">s3</span><span class="o">.</span><span class="n">ap</span><span class="o">-</span><span class="n">northeast</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">install</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">./</span><span class="n">install</span>
<span class="n">sudo</span> <span class="o">./</span><span class="n">install</span> <span class="n">auto</span>
</pre></div>
</div>
<ul class="simple">
<li><p>EC2に必要なポリシーを追加<br /><code class="docutils literal notranslate"><span class="pre">AmazonEC2RoleforAWSCodeDeploy</span></code>のポリシーをEC2に付与したRoleに追加</p></li>
</ul>
<p><img alt="../_images/codedeploy_ec2_role.png" src="../_images/codedeploy_ec2_role.png" /></p>
<ul class="simple">
<li><p>CodeDeployのIAM Roleの作成<br />Roleを作成する際にCodeDeployを選択する</p></li>
</ul>
<p><img alt="../_images/coddedeploy_role.jpeg" src="../_images/coddedeploy_role.jpeg" /></p>
</section>
<section id="id13">
<h3><span class="section-number">4.1.2. </span>CodeDeployの設定<a class="headerlink" href="#id13" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>Code Deployのコンソール画面&gt;アプリケーション&gt;アプリケーションの作成</p>
<ul>
<li><p>アプリケーション名を入力</p></li>
<li><p>コンピューティングプラットフォームに'EC2'を選択</p></li>
</ul>
</li>
</ul>
<p><img alt="../_images/codedeploy_app.png" src="../_images/codedeploy_app.png" /></p>
<ul class="simple">
<li><p>アプリケーションが作成できたら、そのままデプロイグループを作成する</p>
<ul>
<li><p>デプロイグループの名前を入力</p></li>
<li><p>サービスロールは事前に作成したもの
<img alt="../_images/codedeploy_setting1.png" src="../_images/codedeploy_setting1.png" /></p></li>
<li><p>デプロイのグループはキーを利用するのでデプロイ先のEC2のタグを指定する
<img alt="../_images/codedeploy_setting2.png" src="../_images/codedeploy_setting2.png" /></p></li>
<li><p>DodeDeployエージェントのインストールは完了しているので、対応なし
<img alt="../_images/codedeploy_setting3.png" src="../_images/codedeploy_setting3.png" /></p></li>
</ul>
</li>
</ul>
</section>
<section id="codepipeline">
<h3><span class="section-number">4.1.3. </span>CodePipelineの作成<a class="headerlink" href="#codepipeline" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>Pipelineの作成</p>
<ul>
<li><p>パイプライン名を入力</p></li>
<li><p>サービスロールは新規で作成する
<img alt="../_images/codepipeline_sqs_producer.png" src="../_images/codepipeline_sqs_producer.png" /></p></li>
</ul>
</li>
<li><p>ソースプロバイダーは事前作成したCodeCommit</p></li>
<li><p>ビルドステージはスキップ</p></li>
<li><p>デプロイステージは事前に作成したCodeDeploy</p></li>
</ul>
<p><img alt="../_images/codepipeline_sqs_producer_overview.png" src="../_images/codepipeline_sqs_producer_overview.png" /></p>
</section>
</section>
<section id="consumerecscicd">
<h2><span class="section-number">4.2. </span>ConsumerのECSデプロイとCICD<a class="headerlink" href="#consumerecscicd" title="この見出しへのパーマリンク">¶</a></h2>
<p>Consumerは最終的にオートスケーリングを行うことを考えて、ECSでのデプロイを目指す。</p>
<ol class="simple">
<li><p><a class="reference external" href="https://misakifujishiro.github.io/mylogs/Java/intelliJ.html#intellijgithub">IntelliJとGithubを連携</a></p></li>
<li><p><a class="reference external" href="https://misakifujishiro.github.io/mylogs/AWS/CodeSeries.html#code-commit">GithubとCodeCommitのミラーリング</a></p></li>
<li><p>DockerFileの作成</p></li>
<li><p>ECRの設定</p></li>
<li><p>buildspec.ymlの作成</p></li>
<li><p>CodeBuildの設定</p></li>
<li><p>ECSの設定</p></li>
<li><p>Pipelineの作成(Deployまで)</p></li>
</ol>
<section id="dockerfile">
<h3><span class="section-number">4.2.1. </span>Dockerfileの作成<a class="headerlink" href="#dockerfile" title="この見出しへのパーマリンク">¶</a></h3>
<p>javaの環境構築済みのコンテナを起動し、githubからspringプロジェクトをcloneして、コンテナを起動する。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Docker Imageとしてadoptopenjdk11を使用</span>
<span class="n">FROM</span> <span class="n">adoptopenjdk</span><span class="p">:</span><span class="mi">11</span><span class="o">-</span><span class="n">jdk</span><span class="o">-</span><span class="n">hotspot</span>

<span class="c1"># git などのインストール</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> \
       <span class="n">wget</span> <span class="n">tar</span> <span class="n">iproute2</span> <span class="n">git</span>

<span class="c1"># mavenのインストール</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">maven</span>

<span class="c1"># PJのコピー</span>
<span class="n">RUN</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="p">[</span><span class="n">YOUR_GITHUB_URL</span><span class="p">]</span>

<span class="c1"># プロジェクトのビルド</span>
<span class="n">RUN</span> <span class="n">mvn</span> <span class="n">install</span> <span class="o">-</span><span class="n">DskipTests</span><span class="o">=</span><span class="n">true</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">sqs_consumer</span><span class="o">/</span><span class="n">pom</span><span class="o">.</span><span class="n">xml</span>

<span class="c1"># タイムゾーンの変更</span>
<span class="n">RUN</span> <span class="n">ln</span> <span class="o">-</span><span class="n">sf</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">zoneinfo</span><span class="o">/</span><span class="n">Asia</span><span class="o">/</span><span class="n">Tokyo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span>

<span class="c1"># コンテナのポート解放</span>
<span class="n">EXPOSE</span> <span class="mi">8080</span>

<span class="c1"># Javaの実行</span>
<span class="n">CMD</span> <span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">sqs_consumer</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">sqs_consumer</span><span class="o">-</span><span class="mf">0.0.1</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">.</span><span class="n">jar</span>
</pre></div>
</div>
<p>試しに以下のコマンドでカレントディレクトリのDockerfileを利用したdocker imageが作成されるか確認する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">built</span> <span class="o">-</span><span class="n">t</span> <span class="p">[</span><span class="n">YOUR_IMAGE_TAG</span><span class="p">]</span> <span class="o">.</span>
</pre></div>
</div>
</section>
<section id="ecr">
<h3><span class="section-number">4.2.2. </span>ECRの設定<a class="headerlink" href="#ecr" title="この見出しへのパーマリンク">¶</a></h3>
<p>パブリックで、ECRを作成しておく。</p>
</section>
<section id="buildspec-yml">
<h3><span class="section-number">4.2.3. </span>Buildspec.ymlの作成<a class="headerlink" href="#buildspec-yml" title="この見出しへのパーマリンク">¶</a></h3>
<p>codeBuildで作成したDockerFileを利用してDockerImageを作成し、そのDocker ImageをECRへpushするように設定する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - $(aws ecr get-login --no-include-email --region ap-northeast-1)
      - echo ${DOCKER_USER}
      - echo ${DOCKER_PASS} | docker login -u ${DOCKER_USER} --password-stdin
      - AWS_ACCOUNT_ID=$(echo ${CODEBUILD_BUILD_ARN} | cut -f 5 -d :)
      - REPOSITORY_URL=${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-1.amazonaws.com/ma-fujishiroms-sqs-consumer
      - IMAGE_TAG=$(echo ${CODEBUILD_RESOLVED_SOURCE_VERSION} | cut -c 1-7)

  build:
    commands:
      - echo Building the Docker image on `date`
      - docker build --no-cache -t ma-fujishiroms-sqs-consumer:${IMAGE_TAG} .
      - docker tag ma-fujishiroms-sqs-consumer:${IMAGE_TAG} ${REPOSITORY_URL}:${IMAGE_TAG}
  post_build:
    commands:
      - echo Pushing the Docker image on `date`
      - docker push ${REPOSITORY_URL}:${IMAGE_TAG}
      - printf &#39;[{&quot;name&quot;:&quot;MA-fujishiroms-container-sqs-consumer&quot;,&quot;imageUri&quot;:&quot;%s&quot;}]&#39; $REPOSITORY_URL:$IMAGE_TAG &gt; imagedefinitions.json
artifacts:
  files: imagedefinitions.json
</pre></div>
</div>
<p>Dockerを利用する際に、AWSで共通のアカウントを利用している関係で、<a class="reference external" href="https://dev.classmethod.jp/articles/codebuild-has-to-use-dockerhub-login-to-avoid-ip-gacha/">ログイン回数の制限</a>が発生してエラーが発生する可能性がある。</p>
<p>そのために、pre buildでdockerへのログインを行う。<br />以下のCodeBuildを作成する際にbuildステージで環境変数にDOCKER_USERとDOCKER_PASSを登録しておく。</p>
<p><img alt="../_images/sqs_codebuild_env.png" src="../_images/sqs_codebuild_env.png" /></p>
</section>
<section id="codebuild">
<h3><span class="section-number">4.2.4. </span>CodeBuildの設定<a class="headerlink" href="#codebuild" title="この見出しへのパーマリンク">¶</a></h3>
<p>CodeBuildを設定することで、buildspec.ymlが実行され、gitlabにコミットすると、Docker ImageがECRにPushされるようになる。</p>
<p>CodeBuildのコンソールからビルドプロジェクトを作成開始</p>
<ul class="simple">
<li><p>PJ名の入力</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild1.png" src="../_images/sqs_consumer_codebuild1.png" /></p>
<ul class="simple">
<li><p>ソースはCodeCommitのmainブランチ（ここのルートのbuildspecを見る）</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild2.png" src="../_images/sqs_consumer_codebuild2.png" /></p>
<ul class="simple">
<li><p>環境を設定する</p></li>
<li><p>dockerを利用する場合は特権付与にチェックを入れる</p></li>
<li><p>サービスロールは新規で作成するが、後ほどECRへの権限を付与する</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild3.png" src="../_images/sqs_consumer_codebuild3.png" /></p>
<ul class="simple">
<li><p>buidspec.ymlがルートディレクトリにある場合はデフォルトでOK</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild4.png" src="../_images/sqs_consumer_codebuild4.png" /></p>
<ul class="simple">
<li><p>IAM Roleは新規作成した後に<code class="docutils literal notranslate"><span class="pre">AmazonEC2ContainerRegistryPowerUser</span></code>を付与する</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild5.png" src="../_images/sqs_consumer_codebuild5.png" /></p>
<p>この時点でCodeBuildまでのCodePipelineを作成すると、ECRへのpushが行われる</p>
<p><img alt="../_images/codepipeline-sqs-consumer-build.png" src="../_images/codepipeline-sqs-consumer-build.png" /></p>
<p>buildspecで設定した通り、イメージタグにIDが振られている(Latestにならない)</p>
<p><img alt="../_images/ecr-sqs-consumer.png" src="../_images/ecr-sqs-consumer.png" /></p>
</section>
<section id="ecs">
<h3><span class="section-number">4.2.5. </span>ECSの設定<a class="headerlink" href="#ecs" title="この見出しへのパーマリンク">¶</a></h3>
<section id="iam">
<h4><span class="section-number">4.2.5.1. </span>タスクのIAM準備<a class="headerlink" href="#iam" title="この見出しへのパーマリンク">¶</a></h4>
<p>事前に付与するIAM Roleを作成しておく。以下を付与する</p>
<ul class="simple">
<li><p>AmazonECSTaskExecutionRolePolicy</p></li>
<li><p>タスクがアクセスするリソースへの許可<br />sqsやmskにアクセスするので、それに必要なポリシーを付与する（EC2で作成したpolicyと同じもので良い</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;VisualEditor0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;sqs:DeleteMessage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sqs:ReceiveMessage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sqs:SendMessage&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:sqs:ap-northeast-1:[アカウントID]:[SQS_NAME]&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id14">
<h4><span class="section-number">4.2.5.2. </span>タスク定義の設定<a class="headerlink" href="#id14" title="この見出しへのパーマリンク">¶</a></h4>
<p>今回はFargateで設定するため、ネットワークモードがawsvpcになっており、ホストポートを設定しない。</p>
<p><img alt="../_images/ecs-taskdefinition1.png" src="../_images/ecs-taskdefinition1.png" /></p>
<p><img alt="../_images/ecs-taskdefinition2.png" src="../_images/ecs-taskdefinition2.png" /></p>
</section>
<section id="id15">
<h4><span class="section-number">4.2.5.3. </span>サービスの設定<a class="headerlink" href="#id15" title="この見出しへのパーマリンク">¶</a></h4>
<p>今回はFargateで作成するので起動タイプをFargateとする。
作成したタスク定義を指定することで、起動時のコンテナの設定を行う。</p>
<p><img alt="../_images/sqs-consumer-ecs-service-setting1.png" src="../_images/sqs-consumer-ecs-service-setting1.png" /></p>
<p>ネットワークモードとして、VPCやサブネットを選択する。
設定するセキュリティグループの注意点として、コンテナポートに接続できるように設定を行う。（今回は8080にアクセスできるようにインバウンドルールを修正しておく）</p>
<p><img alt="../_images/sqs-consumer-ecs-service-setting2.png" src="../_images/sqs-consumer-ecs-service-setting2.png" /></p>
<p>ロードバランサーの設定はサービスを作成する際にしか設定できない点に注意。</p>
<p>今回は動作確認用に事前に作成したALBを指定する。
ロードバランス用のコンテナとして、TGの作成などをこの場で設定することができる。
こちらで設定すれば、TGの作成およびTGとALBの紐付けを行うことができる。</p>
<p><img alt="../_images/sqs-consumer-ecs-service-setting3.png" src="../_images/sqs-consumer-ecs-service-setting3.png" /></p>
</section>
</section>
<section id="id16">
<h3><span class="section-number">4.2.6. </span>CodeDeployの設定<a class="headerlink" href="#id16" title="この見出しへのパーマリンク">¶</a></h3>
<p>CodePipelineを修正し、Deployステージを設定する。</p>
<p>まず、Code Buildのステージで出力アーティファクトを追加する。</p>
<p><img alt="../_images/codebuild-artifact.png" src="../_images/codebuild-artifact.png" /></p>
<p>次に、Deployステージを追加し、入力アーティファクトにBuildの出力ステージを追加し、対象となるクラスターやサービス名を指定する。</p>
<p>この設定を行うことで、gitlabの修正から、ECRへのpush、ECSのデプロイを自動化することができる。</p>
<p><img alt="../_images/codedeploy-sqs-consumer.png" src="../_images/codedeploy-sqs-consumer.png" /></p>
<p><img alt="../_images/sqs-consumer-pipiline-all.png" src="../_images/sqs-consumer-pipiline-all.png" /></p>
<p>無事ECSが起動できたら、ALBのDNSの後ろに<code class="docutils literal notranslate"><span class="pre">/sqs-consumer</span></code>でアクセスして文字列が表示されるか確認する。</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">2. SQSのチュートリアル実装(CLI編)</a><ul>
<li><a class="reference internal" href="#id1">2.1. キューの作り方</a><ul>
<li><a class="reference internal" href="#cli">2.1.1. CLIで作成する場合</a></li>
<li><a class="reference internal" href="#gui">2.1.2. GUIで作成する場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dlt">2.2. DLTの設定方法</a></li>
<li><a class="reference internal" href="#id2">2.3. メッセージの送受信方法</a><ul>
<li><a class="reference internal" href="#id3">2.3.1. CLIで送信</a></li>
<li><a class="reference internal" href="#id4">2.3.2. コンソールから送信</a></li>
<li><a class="reference internal" href="#id5">2.3.3. 送信の確認</a></li>
<li><a class="reference internal" href="#id6">2.3.4. コンソールで受信確認</a></li>
<li><a class="reference internal" href="#id7">2.3.5. CLIでメッセージ受信と削除</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#sqs-java">3. SQSのチュートリアル実装(Java編)</a><ul>
<li><a class="reference internal" href="#sqs">3.1. SQSの作成</a></li>
<li><a class="reference internal" href="#ec2">3.2. EC2の作成</a></li>
<li><a class="reference internal" href="#java-producer">3.3. Javaのプログラム作成（Producer</a><ul>
<li><a class="reference internal" href="#config">3.3.1. config</a></li>
<li><a class="reference internal" href="#messagesender">3.3.2. MessageSender</a></li>
<li><a class="reference internal" href="#main">3.3.3. main</a></li>
</ul>
</li>
<li><a class="reference internal" href="#java-consumer">3.4. Javaのプログラム作成（Consumer</a><ul>
<li><a class="reference internal" href="#id8">3.4.1. Config</a></li>
<li><a class="reference internal" href="#messagereceiver">3.4.2. MessageReceiver</a></li>
<li><a class="reference internal" href="#frontend">3.4.3. frontend</a></li>
<li><a class="reference internal" href="#id9">3.4.4. main</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id10">3.5. EC2からの実行</a><ul>
<li><a class="reference internal" href="#jar">3.5.1. jarファイルを移動させる</a></li>
<li><a class="reference internal" href="#java">3.5.2. javaのインストール</a></li>
<li><a class="reference internal" href="#id11">3.5.3. 結果</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id12">4. SQSの開発環境構築</a><ul>
<li><a class="reference internal" href="#producercicd">4.1. ProducerのCICD</a><ul>
<li><a class="reference internal" href="#codedeploy">4.1.1. CodeDeployの準備</a></li>
<li><a class="reference internal" href="#id13">4.1.2. CodeDeployの設定</a></li>
<li><a class="reference internal" href="#codepipeline">4.1.3. CodePipelineの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#consumerecscicd">4.2. ConsumerのECSデプロイとCICD</a><ul>
<li><a class="reference internal" href="#dockerfile">4.2.1. Dockerfileの作成</a></li>
<li><a class="reference internal" href="#ecr">4.2.2. ECRの設定</a></li>
<li><a class="reference internal" href="#buildspec-yml">4.2.3. Buildspec.ymlの作成</a></li>
<li><a class="reference internal" href="#codebuild">4.2.4. CodeBuildの設定</a></li>
<li><a class="reference internal" href="#ecs">4.2.5. ECSの設定</a><ul>
<li><a class="reference internal" href="#iam">4.2.5.1. タスクのIAM準備</a></li>
<li><a class="reference internal" href="#id14">4.2.5.2. タスク定義の設定</a></li>
<li><a class="reference internal" href="#id15">4.2.5.3. サービスの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id16">4.2.6. CodeDeployの設定</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="cloudformaiton_CICD.html"
                          title="前の章へ"><span class="section-number">1. </span>CodePipelineを利用してCFNのCICD環境を作成する</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="MSK.html"
                          title="次の章へ"><span class="section-number">5. </span>MSKのチュートリアル実装(CLI編)</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/HandsOn/SQS.md.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="MSK.html" title="5. MSKのチュートリアル実装(CLI編)"
             >次へ</a> |</li>
        <li class="right" >
          <a href="cloudformaiton_CICD.html" title="1. CodePipelineを利用してCFNのCICD環境を作成する"
             >前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">my_sphinx  ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">2. </span>SQSのチュートリアル実装(CLI編)</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, sphinx_user.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.2.3.
    </div>
  </body>
</html>