
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>2. SQSのチュートリアル実装(CLI編) &#8212; my_sphinx  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/translations.js"></script>
    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="7. MSKのチュートリアル実装(CLI編)" href="MSK.html" />
    <link rel="prev" title="1. CodePipelineを利用してCFNのCICD環境を作成する" href="cloudformaiton_CICD.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="MSK.html" title="7. MSKのチュートリアル実装(CLI編)"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="cloudformaiton_CICD.html" title="1. CodePipelineを利用してCFNのCICD環境を作成する"
             accesskey="P">前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">my_sphinx  ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">2. </span>SQSのチュートリアル実装(CLI編)</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="sqs-cli">
<h1><span class="section-number">2. </span>SQSのチュートリアル実装(CLI編)<a class="headerlink" href="#sqs-cli" title="この見出しへのパーマリンク">¶</a></h1>
<p>以下の内容に関して理解するためにチュートリアルを行う</p>
<ul class="simple">
<li><p>キューの作り方</p></li>
<li><p>DLTの設定方法</p></li>
<li><p>メッセージの送受信方法</p></li>
</ul>
<p>参考にしたサイト</p>
<ul class="simple">
<li><p><a class="reference external" href="https://weblabo.oscasierra.net/aws-sqs-tutorial/">CLIで作成・送受信</a></p></li>
</ul>
<section id="id1">
<h2><span class="section-number">2.1. </span>キューの作り方<a class="headerlink" href="#id1" title="この見出しへのパーマリンク">¶</a></h2>
<p>SQSのキューの作成方法について整理する</p>
<section id="cli">
<h3><span class="section-number">2.1.1. </span>CLIで作成する場合<a class="headerlink" href="#cli" title="この見出しへのパーマリンク">¶</a></h3>
<p>まずは、キューが存在するかの確認。以下コマンドで、現在のキューを確認できる。何もない場合は返値なし</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs list-queues
</pre></div>
</div>
<p>キューの作成はcreate-queueコマンド（以下は標準キューを作成する場合）</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs create-queue --queue-name [YOUR_QUEUE_NAME]
{
    &quot;QueueUrl&quot;: &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot;
}
</pre></div>
</div>
<p>FIFOキューを作成する場合は、キュー名の最後に<code class="docutils literal notranslate"><span class="pre">.fifo</span></code>を追加して、FifoQueue=Trueのオプションを追加する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs create-queue --queue-name [YOUR_QUEUE_NAME].fifo --attributes FifoQueue=true
</pre></div>
</div>
<p>改めて、キューの確認を行うと作成したキューが確認できる</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs list-queues
{
    &quot;QueueUrls&quot;: [
        &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot;
    ]
}
</pre></div>
</div>
<p>また、作成したキューについての詳細を<code class="docutils literal notranslate"><span class="pre">get-queue-attributes</span></code>で表示させることができる</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs get-queue-attributes --attribute-names All --queue-url https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME] 

{
    &quot;Attributes&quot;: {
        &quot;QueueArn&quot;: &quot;arn:aws:sqs:ap-northeast-1:[AWS_ACCOUNT_ID]:[YOUR_QUEUE_NAME]&quot;,
        &quot;ApproximateNumberOfMessages&quot;: &quot;0&quot;,
        &quot;ApproximateNumberOfMessagesNotVisible&quot;: &quot;0&quot;,
        &quot;ApproximateNumberOfMessagesDelayed&quot;: &quot;0&quot;,
        &quot;CreatedTimestamp&quot;: &quot;1683331260&quot;,
        &quot;LastModifiedTimestamp&quot;: &quot;1683331260&quot;,
        &quot;VisibilityTimeout&quot;: &quot;30&quot;,
        &quot;MaximumMessageSize&quot;: &quot;262144&quot;,
        &quot;MessageRetentionPeriod&quot;: &quot;345600&quot;,
        &quot;DelaySeconds&quot;: &quot;0&quot;,
        &quot;ReceiveMessageWaitTimeSeconds&quot;: &quot;0&quot;,
        &quot;SqsManagedSseEnabled&quot;: &quot;true&quot;
    }
}
</pre></div>
</div>
<p>得られる属性値のうち、キューの状態を表すものは以下</p>
<ul class="simple">
<li><p>ApproximateNumberOfMessages<br />未処理のメッセージの数</p></li>
<li><p>ApproximateNumberOfMessagesNotVisible<br />Consumerが取得したが、処理完了していないメッセージ数（処理中のメッセージ数）</p></li>
<li><p>ApproximateNumberOfMessagesDelayed<br />遅延時間が設定されているメッセージ数（Consumer処理可能になるまで待機しているメッセージ数）</p></li>
</ul>
<p>得られる属性値のうち、キューの設定値を表すものは以下</p>
<ul class="simple">
<li><p>VisibilityTimeout<br />可視性タイムアウト（他のConsumerにメッセージが見えるようになるまでの時間）</p></li>
<li><p>DelaySeconds<br />遅延時間（受信してから、Consumerがメッセージが見えるようになるまでの時間）<br />この遅延時間はキュー全体に対して適用される。</p></li>
<li><p>ReceiveMessageWaitTimeSeconds<br />メッセージがポーリングされる際の最大待機時間</p></li>
<li><p>MessageRetentionPeriod<br />メッセージが保管される期間</p></li>
</ul>
<p>コンソールから確認すると以下</p>
<p><img alt="../_images/sqs_setting.png" src="../_images/sqs_setting.png" /></p>
</section>
<section id="gui">
<h3><span class="section-number">2.1.2. </span>GUIで作成する場合<a class="headerlink" href="#gui" title="この見出しへのパーマリンク">¶</a></h3>
<p>キュータイプと名前を指定する</p>
<p><img alt="../_images/sqs_setting_manual1.png" src="../_images/sqs_setting_manual1.png" /></p>
<p>キューに対する遅延時間や可視性タイムアウトを設定する</p>
<p><img alt="../_images/sqs_setting_manual2.png" src="../_images/sqs_setting_manual2.png" /></p>
<p>暗号化とアクセスポリシーを設定する</p>
<p><img alt="../_images/sqs_setting_manual3.png" src="../_images/sqs_setting_manual3.png" /></p>
</section>
</section>
<section id="dlt">
<h2><span class="section-number">2.2. </span>DLTの設定方法<a class="headerlink" href="#dlt" title="この見出しへのパーマリンク">¶</a></h2>
<p>CLIから作成する場合は、<code class="docutils literal notranslate"><span class="pre">RedrivePolicy</span></code>をオプションとして指定することで作成することができるが、詳細は<a class="reference external" href="https://docs.aws.amazon.com/cli/latest/reference/sqs/create-queue.html">公式ドキュメント</a>を参照されたい。</p>
<p>コンソール画面からは、キューを作成や更新する際に指定することができる。注意点として、DLQは送信元のキューと同じキュータイプ（標準・FIFO）を設定する必要がある。</p>
<p><img alt="../_images/sqs_dlq_setting.png" src="../_images/sqs_dlq_setting.png" /></p>
<p>最大受信数に設定した回数、キューが失敗した場合にDLQに送信される。</p>
</section>
<section id="id2">
<h2><span class="section-number">2.3. </span>メッセージの送受信方法<a class="headerlink" href="#id2" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id3">
<h3><span class="section-number">2.3.1. </span>CLIで送信<a class="headerlink" href="#id3" title="この見出しへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">send-message</span></code>を利用してメッセージを送信するとメッセージIDとメッセージのハッシュが返却される</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aws</span> <span class="n">sqs</span> <span class="n">send</span><span class="o">-</span><span class="n">message</span> <span class="o">--</span><span class="n">queue</span><span class="o">-</span><span class="n">url</span> <span class="s2">&quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot;</span> <span class="o">--</span><span class="n">message</span><span class="o">-</span><span class="n">body</span> <span class="s2">&quot;hello world&quot;</span>
<span class="p">{</span>
    <span class="s2">&quot;MD5OfMessageBody&quot;</span><span class="p">:</span> <span class="s2">&quot;5eb63bbbe01eeed093cb22bb8f5acdc3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MessageId&quot;</span><span class="p">:</span> <span class="s2">&quot;1db7869e-5ca0-4e97-810c-bb7b7b7522bc&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3><span class="section-number">2.3.2. </span>コンソールから送信<a class="headerlink" href="#id4" title="この見出しへのパーマリンク">¶</a></h3>
<p>SQSのコンソールから、キューを選択しメッセージを送受信を選択</p>
<p><img alt="../_images/sqs_txrx_console.png" src="../_images/sqs_txrx_console.png" /></p>
<p>メッセージを送信タブから、メッセージ本文を記載して送信する</p>
<p><img alt="../_images/sqs_tx_console.png" src="../_images/sqs_tx_console.png" /></p>
</section>
<section id="id5">
<h3><span class="section-number">2.3.3. </span>送信の確認<a class="headerlink" href="#id5" title="この見出しへのパーマリンク">¶</a></h3>
<p>CLIから<code class="docutils literal notranslate"><span class="pre">ApproximateNumberOfMessages</span></code>を確認する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs get-queue-attributes --attribute-names ApproximateNumberOfMessages  --queue-url &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot; 
{
    &quot;Attributes&quot;: {
        &quot;ApproximateNumberOfMessages&quot;: &quot;2&quot;
    }
}
</pre></div>
</div>
<p>もしくは、コンソールから<code class="docutils literal notranslate"><span class="pre">利用可能なメッセージ</span></code>を確認する</p>
<p><img alt="../_images/sqs_message_num.png" src="../_images/sqs_message_num.png" /></p>
</section>
<section id="id6">
<h3><span class="section-number">2.3.4. </span>コンソールで受信確認<a class="headerlink" href="#id6" title="この見出しへのパーマリンク">¶</a></h3>
<p>まず、コンソールからキュー内のメッセージを受信することができる。
注意点は、SQSはメッセージを受信しただけではなく、削除までする必要があるので、このオペレーションを繰り返すと、受信回数が増えてDLQに移動してしまうこと。</p>
<p>SQSのコンソールから、キューを選択しメッセージを送受信を選択</p>
<p><img alt="../_images/sqs_txrx_console.png" src="../_images/sqs_txrx_console.png" /></p>
<p>メッセージを受信タブから、メッセージをポーリングする</p>
<p><img alt="../_images/sqs_rx_console1.png" src="../_images/sqs_rx_console1.png" /></p>
<p>ポーリングの結果得られたメッセージを押下すると、本文などが確認できる。</p>
<p><img alt="../_images/sqs_rx_console2.png" src="../_images/sqs_rx_console2.png" /></p>
<p>ポーリングをDLQで設定した回数分行うとDLQに移動する</p>
</section>
<section id="id7">
<h3><span class="section-number">2.3.5. </span>CLIでメッセージ受信と削除<a class="headerlink" href="#id7" title="この見出しへのパーマリンク">¶</a></h3>
<p>次に、メッセージをコンソールから受信し、その上で削除を行う。</p>
<p>メッセージの受信は<code class="docutils literal notranslate"><span class="pre">receive-message</span></code>を利用する。メッセージは複数格納されていても、1つのメッセージだけが受信される</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs receive-message --queue-url &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot; 
{
    &quot;Messages&quot;: [
        {
            &quot;MessageId&quot;: &quot;698a7959-7d80-4125-9ccf-2a1a52334606&quot;,
            &quot;ReceiptHandle&quot;: &quot;AQEBQfRoUCKb74uFFlmZT~~~~&quot;,
            &quot;MD5OfBody&quot;: &quot;11b1d675d840f10f85fed95d4af7264a&quot;,
            &quot;Body&quot;: &quot;message_from_console1&quot;
        }
    ]
}
</pre></div>
</div>
<p>SQSではメッセージの処理が完了したら、明示的にメッセージの削除を行う必要がある。
メッセージの削除は<code class="docutils literal notranslate"><span class="pre">delete-message</span></code>を利用する。また、メッセージを指定するために受信した際に受け取った`ReceiptHandle&quot;を指定して削除するメッセージを決める</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws sqs delete-message --queue-url &quot;https://sqs.ap-northeast-1.amazonaws.com/[AWS_ACCOUNT_ID]/[YOUR_QUEUE_NAME]&quot; --receipt-handle &quot;AQEBQfRoUCKb74uFFlmZT~~~~&quot;
</pre></div>
</div>
<p>削除されたことで、メッセージキューにも、DLQにもメッセージが存在しないことが確認できる。</p>
</section>
</section>
</section>
<section id="sqs">
<h1><span class="section-number">3. </span>SQSの開発環境構築<a class="headerlink" href="#sqs" title="この見出しへのパーマリンク">¶</a></h1>
<section id="producerec2">
<h2><span class="section-number">3.1. </span>ProducerのEC2の作成<a class="headerlink" href="#producerec2" title="この見出しへのパーマリンク">¶</a></h2>
<p>基本的にはデフォルトでEC2を作成。</p>
<p>IAMについては以下のポリシーを持つIAMポリシーを作成しておき付与する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;VisualEditor0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;sqs:DeleteMessage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sqs:ReceiveMessage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sqs:SendMessage&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:sqs:ap-northeast-1:[アカウントID]:[SQS_NAME]&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="producercicd">
<h2><span class="section-number">3.2. </span>ProducerのCICD<a class="headerlink" href="#producercicd" title="この見出しへのパーマリンク">¶</a></h2>
<p>Producer側はバッチで処理を流すので、CodeDeployでEC2上にjarファイルをデプロイする</p>
<ol class="simple">
<li><p><a class="reference external" href="https://misakifujishiro.github.io/mylogs/Java/intelliJ.html#intellijgithub">IntelliJとGithubを連携</a></p></li>
<li><p><a class="reference external" href="https://misakifujishiro.github.io/mylogs/AWS/CodeSeries.html#code-commit">GithubとCodeCommitのミラーリング</a></p></li>
<li><p>CodeDeoloyの準備</p></li>
<li><p>CodeDeployの設定</p></li>
<li><p>CodePipelineの作成</p></li>
</ol>
<section id="codedeploy">
<h3><span class="section-number">3.2.1. </span>CodeDeployの準備<a class="headerlink" href="#codedeploy" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>appspec.ymlをJava PJのルートディレクトリに配置する</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="mf">0.0</span>
<span class="n">os</span><span class="p">:</span> <span class="n">linux</span>
<span class="n">files</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">source</span><span class="p">:</span> <span class="n">target</span><span class="o">/</span><span class="n">sqs_producer</span><span class="o">-</span><span class="mf">0.0.1</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">.</span><span class="n">jar</span>
    <span class="n">destination</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">/</span>
<span class="n">permissions</span><span class="p">:</span>
  <span class="o">-</span> <span class="nb">object</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">/</span><span class="n">sqs_producer</span><span class="o">-</span><span class="mf">0.0.1</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">.</span><span class="n">jar</span>
    <span class="n">mode</span><span class="p">:</span> <span class="mi">755</span>
</pre></div>
</div>
<ul class="simple">
<li><p>EC2にcodedeployエージェントをインストール</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">ruby</span>
<span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">aws</span><span class="o">-</span><span class="n">cli</span>
<span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">aws</span><span class="o">-</span><span class="n">codedeploy</span><span class="o">-</span><span class="n">ap</span><span class="o">-</span><span class="n">northeast</span><span class="o">-</span><span class="mf">1.</span><span class="n">s3</span><span class="o">.</span><span class="n">ap</span><span class="o">-</span><span class="n">northeast</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">install</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">./</span><span class="n">install</span>
<span class="n">sudo</span> <span class="o">./</span><span class="n">install</span> <span class="n">auto</span>
</pre></div>
</div>
<ul class="simple">
<li><p>EC2に必要なポリシーを追加<br /><code class="docutils literal notranslate"><span class="pre">AmazonEC2RoleforAWSCodeDeploy</span></code>のポリシーをEC2に付与したRoleに追加</p></li>
</ul>
<p><img alt="../_images/codedeploy_ec2_role.png" src="../_images/codedeploy_ec2_role.png" /></p>
<ul class="simple">
<li><p>CodeDeployのIAM Roleの作成<br />Roleを作成する際にCodeDeployを選択する</p></li>
</ul>
<p><img alt="../_images/coddedeploy_role.jpeg" src="../_images/coddedeploy_role.jpeg" /></p>
</section>
<section id="id8">
<h3><span class="section-number">3.2.2. </span>CodeDeployの設定<a class="headerlink" href="#id8" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>Code Deployのコンソール画面&gt;アプリケーション&gt;アプリケーションの作成</p>
<ul>
<li><p>アプリケーション名を入力</p></li>
<li><p>コンピューティングプラットフォームに'EC2'を選択</p></li>
</ul>
</li>
</ul>
<p><img alt="../_images/codedeploy_app.png" src="../_images/codedeploy_app.png" /></p>
<ul class="simple">
<li><p>アプリケーションが作成できたら、そのままデプロイグループを作成する</p>
<ul>
<li><p>デプロイグループの名前を入力</p></li>
<li><p>サービスロールは事前に作成したもの
<img alt="../_images/codedeploy_setting1.png" src="../_images/codedeploy_setting1.png" /></p></li>
<li><p>デプロイのグループはキーを利用するのでデプロイ先のEC2のタグを指定する
<img alt="../_images/codedeploy_setting2.png" src="../_images/codedeploy_setting2.png" /></p></li>
<li><p>DodeDeployエージェントのインストールは完了しているので、対応なし
<img alt="../_images/codedeploy_setting3.png" src="../_images/codedeploy_setting3.png" /></p></li>
</ul>
</li>
</ul>
</section>
<section id="codepipeline">
<h3><span class="section-number">3.2.3. </span>CodePipelineの作成<a class="headerlink" href="#codepipeline" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>Pipelineの作成</p>
<ul>
<li><p>パイプライン名を入力</p></li>
<li><p>サービスロールは新規で作成する
<img alt="../_images/codepipeline_sqs_producer.png" src="../_images/codepipeline_sqs_producer.png" /></p></li>
</ul>
</li>
<li><p>ソースプロバイダーは事前作成したCodeCommit</p></li>
<li><p>ビルドステージはスキップ</p></li>
<li><p>デプロイステージは事前に作成したCodeDeploy</p></li>
</ul>
<p><img alt="../_images/codepipeline_sqs_producer_overview.png" src="../_images/codepipeline_sqs_producer_overview.png" /></p>
</section>
</section>
<section id="consumerecscicd">
<h2><span class="section-number">3.3. </span>ConsumerのECSデプロイとCICD<a class="headerlink" href="#consumerecscicd" title="この見出しへのパーマリンク">¶</a></h2>
<p>Consumerは最終的にオートスケーリングを行うことを考えて、ECSでのデプロイを目指す。</p>
<ol class="simple">
<li><p><a class="reference external" href="https://misakifujishiro.github.io/mylogs/Java/intelliJ.html#intellijgithub">IntelliJとGithubを連携</a></p></li>
<li><p><a class="reference external" href="https://misakifujishiro.github.io/mylogs/AWS/CodeSeries.html#code-commit">GithubとCodeCommitのミラーリング</a></p></li>
<li><p>DockerFileの作成</p></li>
<li><p>ECRの設定</p></li>
<li><p>buildspec.ymlの作成</p></li>
<li><p>CodeBuildの設定</p></li>
<li><p>ECSの設定</p></li>
<li><p>Pipelineの作成(Deployまで)</p></li>
</ol>
<section id="dockerfile">
<h3><span class="section-number">3.3.1. </span>Dockerfileの作成<a class="headerlink" href="#dockerfile" title="この見出しへのパーマリンク">¶</a></h3>
<p>javaの環境構築済みのコンテナを起動し、githubからspringプロジェクトをcloneして、コンテナを起動する。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Docker Imageとしてadoptopenjdk11を使用</span>
<span class="n">FROM</span> <span class="n">adoptopenjdk</span><span class="p">:</span><span class="mi">11</span><span class="o">-</span><span class="n">jdk</span><span class="o">-</span><span class="n">hotspot</span>

<span class="c1"># git などのインストール</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> \
       <span class="n">wget</span> <span class="n">tar</span> <span class="n">iproute2</span> <span class="n">git</span>

<span class="c1"># mavenのインストール</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">maven</span>

<span class="c1"># PJのコピー</span>
<span class="n">RUN</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="p">[</span><span class="n">YOUR_GITHUB_URL</span><span class="p">]</span>

<span class="c1"># プロジェクトのビルド</span>
<span class="n">RUN</span> <span class="n">mvn</span> <span class="n">install</span> <span class="o">-</span><span class="n">DskipTests</span><span class="o">=</span><span class="n">true</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">sqs_consumer</span><span class="o">/</span><span class="n">pom</span><span class="o">.</span><span class="n">xml</span>

<span class="c1"># タイムゾーンの変更</span>
<span class="n">RUN</span> <span class="n">ln</span> <span class="o">-</span><span class="n">sf</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">zoneinfo</span><span class="o">/</span><span class="n">Asia</span><span class="o">/</span><span class="n">Tokyo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span>

<span class="c1"># コンテナのポート解放</span>
<span class="n">EXPOSE</span> <span class="mi">8080</span>

<span class="c1"># Javaの実行</span>
<span class="n">CMD</span> <span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">sqs_consumer</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">sqs_consumer</span><span class="o">-</span><span class="mf">0.0.1</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">.</span><span class="n">jar</span>
</pre></div>
</div>
<p>試しに以下のコマンドでカレントディレクトリのDockerfileを利用したdocker imageが作成されるか確認する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">built</span> <span class="o">-</span><span class="n">t</span> <span class="p">[</span><span class="n">YOUR_IMAGE_TAG</span><span class="p">]</span> <span class="o">.</span>
</pre></div>
</div>
</section>
<section id="ecr">
<h3><span class="section-number">3.3.2. </span>ECRの設定<a class="headerlink" href="#ecr" title="この見出しへのパーマリンク">¶</a></h3>
<p>パブリックで、ECRを作成しておく。</p>
</section>
<section id="buildspec-yml">
<h3><span class="section-number">3.3.3. </span>Buildspec.ymlの作成<a class="headerlink" href="#buildspec-yml" title="この見出しへのパーマリンク">¶</a></h3>
<p>codeBuildで作成したDockerFileを利用してDockerImageを作成し、そのDocker ImageをECRへpushするように設定する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - $(aws ecr get-login --no-include-email --region ap-northeast-1)
      - echo ${DOCKER_USER}
      - echo ${DOCKER_PASS} | docker login -u ${DOCKER_USER} --password-stdin
      - AWS_ACCOUNT_ID=$(echo ${CODEBUILD_BUILD_ARN} | cut -f 5 -d :)
      - REPOSITORY_URL=${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-1.amazonaws.com/ma-fujishiroms-sqs-consumer
      - IMAGE_TAG=$(echo ${CODEBUILD_RESOLVED_SOURCE_VERSION} | cut -c 1-7)

  build:
    commands:
      - echo Building the Docker image on `date`
      - docker build --no-cache -t ma-fujishiroms-sqs-consumer:${IMAGE_TAG} .
      - docker tag ma-fujishiroms-sqs-consumer:${IMAGE_TAG} ${REPOSITORY_URL}:${IMAGE_TAG}
  post_build:
    commands:
      - echo Pushing the Docker image on `date`
      - docker push ${REPOSITORY_URL}:${IMAGE_TAG}
      - printf &#39;[{&quot;name&quot;:&quot;MA-fujishiroms-container-sqs-consumer&quot;,&quot;imageUri&quot;:&quot;%s&quot;}]&#39; $REPOSITORY_URL:$IMAGE_TAG &gt; imagedefinitions.json
artifacts:
  files: imagedefinitions.json
</pre></div>
</div>
<p>Dockerを利用する際に、AWSで共通のアカウントを利用している関係で、<a class="reference external" href="https://dev.classmethod.jp/articles/codebuild-has-to-use-dockerhub-login-to-avoid-ip-gacha/">ログイン回数の制限</a>が発生してエラーが発生する可能性がある。</p>
<p>そのために、pre buildでdockerへのログインを行う。<br />以下のCodeBuildを作成する際にbuildステージで環境変数にDOCKER_USERとDOCKER_PASSを登録しておく。</p>
<p><img alt="../_images/sqs_codebuild_env.png" src="../_images/sqs_codebuild_env.png" /></p>
</section>
<section id="codebuild">
<h3><span class="section-number">3.3.4. </span>CodeBuildの設定<a class="headerlink" href="#codebuild" title="この見出しへのパーマリンク">¶</a></h3>
<p>CodeBuildを設定することで、buildspec.ymlが実行され、gitlabにコミットすると、Docker ImageがECRにPushされるようになる。</p>
<p>CodeBuildのコンソールからビルドプロジェクトを作成開始</p>
<ul class="simple">
<li><p>PJ名の入力</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild1.png" src="../_images/sqs_consumer_codebuild1.png" /></p>
<ul class="simple">
<li><p>ソースはCodeCommitのmainブランチ（ここのルートのbuildspecを見る）</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild2.png" src="../_images/sqs_consumer_codebuild2.png" /></p>
<ul class="simple">
<li><p>環境を設定する</p></li>
<li><p>dockerを利用する場合は特権付与にチェックを入れる</p></li>
<li><p>サービスロールは新規で作成するが、後ほどECRへの権限を付与する</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild3.png" src="../_images/sqs_consumer_codebuild3.png" /></p>
<ul class="simple">
<li><p>buidspec.ymlがルートディレクトリにある場合はデフォルトでOK</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild4.png" src="../_images/sqs_consumer_codebuild4.png" /></p>
<ul class="simple">
<li><p>IAM Roleは新規作成した後に<code class="docutils literal notranslate"><span class="pre">AmazonEC2ContainerRegistryPowerUser</span></code>を付与する</p></li>
</ul>
<p><img alt="../_images/sqs_consumer_codebuild5.png" src="../_images/sqs_consumer_codebuild5.png" /></p>
<p>この時点でCodeBuildまでのCodePipelineを作成すると、ECRへのpushが行われる</p>
<p><img alt="../_images/codepipeline-sqs-consumer-build.png" src="../_images/codepipeline-sqs-consumer-build.png" /></p>
<p>buildspecで設定した通り、イメージタグにIDが振られている(Latestにならない)</p>
<p><img alt="../_images/ecr-sqs-consumer.png" src="../_images/ecr-sqs-consumer.png" /></p>
</section>
<section id="ecs">
<h3><span class="section-number">3.3.5. </span>ECSの設定<a class="headerlink" href="#ecs" title="この見出しへのパーマリンク">¶</a></h3>
<section id="iam">
<h4><span class="section-number">3.3.5.1. </span>タスクのIAM準備<a class="headerlink" href="#iam" title="この見出しへのパーマリンク">¶</a></h4>
<p>事前に付与するIAM Roleを作成しておく。以下を付与する</p>
<ul class="simple">
<li><p>AmazonECSTaskExecutionRolePolicy</p></li>
<li><p>タスクがアクセスするリソースへの許可<br />sqsやmskにアクセスするので、それに必要なポリシーを付与する（EC2で作成したpolicyと同じもので良い</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;VisualEditor0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;sqs:DeleteMessage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sqs:ReceiveMessage&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sqs:SendMessage&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:sqs:ap-northeast-1:[アカウントID]:[SQS_NAME]&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id9">
<h4><span class="section-number">3.3.5.2. </span>タスク定義の設定<a class="headerlink" href="#id9" title="この見出しへのパーマリンク">¶</a></h4>
<p>今回はFargateで設定するため、ネットワークモードがawsvpcになっており、ホストポートを設定しない。</p>
<p><img alt="../_images/ecs-taskdefinition1.png" src="../_images/ecs-taskdefinition1.png" /></p>
<p><img alt="../_images/ecs-taskdefinition2.png" src="../_images/ecs-taskdefinition2.png" /></p>
</section>
<section id="id10">
<h4><span class="section-number">3.3.5.3. </span>サービスの設定<a class="headerlink" href="#id10" title="この見出しへのパーマリンク">¶</a></h4>
<p>今回はFargateで作成するので起動タイプをFargateとする。
作成したタスク定義を指定することで、起動時のコンテナの設定を行う。</p>
<p><img alt="../_images/sqs-consumer-ecs-service-setting1.png" src="../_images/sqs-consumer-ecs-service-setting1.png" /></p>
<p>ネットワークモードとして、VPCやサブネットを選択する。
設定するセキュリティグループの注意点として、コンテナポートに接続できるように設定を行う。（今回は8080にアクセスできるようにインバウンドルールを修正しておく）</p>
<p><img alt="../_images/sqs-consumer-ecs-service-setting2.png" src="../_images/sqs-consumer-ecs-service-setting2.png" /></p>
<p>ロードバランサーの設定はサービスを作成する際にしか設定できない点に注意。</p>
<p>今回は動作確認用に事前に作成したALBを指定する。
ロードバランス用のコンテナとして、TGの作成などをこの場で設定することができる。
こちらで設定すれば、TGの作成およびTGとALBの紐付けを行うことができる。</p>
<p><img alt="../_images/sqs-consumer-ecs-service-setting3.png" src="../_images/sqs-consumer-ecs-service-setting3.png" /></p>
</section>
</section>
<section id="id11">
<h3><span class="section-number">3.3.6. </span>CodeDeployの設定<a class="headerlink" href="#id11" title="この見出しへのパーマリンク">¶</a></h3>
<p>CodePipelineを修正し、Deployステージを設定する。</p>
<p>まず、Code Buildのステージで出力アーティファクトを追加する。</p>
<p><img alt="../_images/codebuild-artifact.png" src="../_images/codebuild-artifact.png" /></p>
<p>次に、Deployステージを追加し、入力アーティファクトにBuildの出力ステージを追加し、対象となるクラスターやサービス名を指定する。</p>
<p>この設定を行うことで、gitlabの修正から、ECRへのpush、ECSのデプロイを自動化することができる。</p>
<p><img alt="../_images/codedeploy-sqs-consumer.png" src="../_images/codedeploy-sqs-consumer.png" /></p>
<p><img alt="../_images/sqs-consumer-pipiline-all.png" src="../_images/sqs-consumer-pipiline-all.png" /></p>
<p>無事ECSが起動できたら、ALBのDNSの後ろに<code class="docutils literal notranslate"><span class="pre">/sqs-consumer</span></code>でアクセスして文字列が表示されるか確認する。</p>
</section>
</section>
</section>
<section id="sqs-java">
<h1><span class="section-number">4. </span>SQSのチュートリアル実装(Java編)<a class="headerlink" href="#sqs-java" title="この見出しへのパーマリンク">¶</a></h1>
<p>参考サイト</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.stsd.co.jp/dev-blog/send_and_receive_amazon_sqs_messages_from_java.html">JavaからAmazon SQSのメッセージ送受信を行う</a></p></li>
<li><p><a class="reference external" href="https://weblabo.oscasierra.net/aws-sqs-tutorial-java-1/">JavaでAmazon SQSのメッセージを送受信するチュートリアル</a></p></li>
</ul>
<section id="id12">
<h2><span class="section-number">4.1. </span>SQSの作成<a class="headerlink" href="#id12" title="この見出しへのパーマリンク">¶</a></h2>
<p>SQSは前資料で作成した標準キューを再利用する</p>
</section>
<section id="java-producer">
<h2><span class="section-number">4.2. </span>Javaのプログラム作成（Producer<a class="headerlink" href="#java-producer" title="この見出しへのパーマリンク">¶</a></h2>
<p>JavaからSQSへのアクセスには、AWS公式のライブラリ<code class="docutils literal notranslate"><span class="pre">aws-java-sdk-sqs</span></code>を利用することとする。pomに以下を追加する。</p>
<p>pom.xml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="o">.</span><span class="n">amazonaws</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">aws</span><span class="o">-</span><span class="n">java</span><span class="o">-</span><span class="n">sdk</span><span class="o">-</span><span class="n">sqs</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">1.12.116</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
<section id="config">
<h3><span class="section-number">4.2.1. </span>config<a class="headerlink" href="#config" title="この見出しへのパーマリンク">¶</a></h3>
<p>src/main/javaにconfigのディレクトリを作成して、<code class="docutils literal notranslate"><span class="pre">sqsConfig</span></code>を作成する</p>
<ul class="simple">
<li><p>&#64;configurationクラスの宣言<br />設定クラスであることを宣言し、SpringにConfigクラスと認識させる。このクラスの配下では&#64;Beanを付与することで対象クラスの返り値のオブジェクトをSpringの管理下に置かれ、他のクラスからはAmazonSQSクライアントを新規作成するのではなく、このAmazonSQSを呼び出すことで利用することができる。<br />今回はSQSクライアントというサードパーティのメソッドで作成されるオブジェクトを管理したいので設定クラスで定義する。</p></li>
<li><p>AmaozonSQSClientBuilder<br />SQSのデフォルトのクライアントインスタンスを作成している。<br />一旦デフォルト値を使用して、SQSのクライアントに対して、認証情報やリージョンの情報を渡している。メッセージに関する詳細なやりとりに関しては別で実装する。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_producer</span><span class="o">.</span><span class="n">config</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.AmazonSQS</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.AmazonSQSClientBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>

<span class="nd">@Configuration</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">sqsConfig</span> <span class="p">{</span>
    <span class="nd">@Bean</span>
    <span class="n">public</span> <span class="n">AmazonSQS</span> <span class="n">amazonSQSClient</span><span class="p">(){</span>
        <span class="k">return</span> <span class="n">AmazonSQSClientBuilder</span><span class="o">.</span><span class="n">defaultClient</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="messagesender">
<h3><span class="section-number">4.2.2. </span>MessageSender<a class="headerlink" href="#messagesender" title="この見出しへのパーマリンク">¶</a></h3>
<p>src/main/javaにMessageSenderクラスを作成する<br />このクラスでは、SQSへメッセージを送信するメソッドを定義する。</p>
<ul class="simple">
<li><p>&#64;Componentクラスの宣言<br />今回は、自分で作成するクラスを他のクラスでも呼び出し、依存性の注入を行いたいので&#64;componentで宣言する。</p></li>
<li><p>&#64;Autowiredによる依存性注入<br />&#64;Autowiredを利用して、設定クラスで宣言したSQSClientを呼び出している。</p></li>
<li><p>メッセージ送信メソッド</p>
<ul>
<li><p>メッセージ詳細<br />ランダムに数字を生成して、文字列に変換している</p></li>
<li><p>SQSのメッセージ送信リクエストを作成</p>
<ul>
<li><p>withDelaySecondsは、送信してからConsumerが見えるようになるまでの時間でメッセージごとに設定可能</p></li>
</ul>
</li>
<li><p>SQSのコンソール画面から設定した、<code class="docutils literal notranslate"><span class="pre">DelaySeconds</span></code>はキュー全体に対する遅延時間。</p></li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_producer</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.AmazonSQS</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.amazonaws.services.sqs.model.SendMessageRequest</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>

<span class="nd">@Component</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">MessageSender</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">private</span> <span class="n">AmazonSQS</span> <span class="n">amazonSQSClient</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">sendMessage</span><span class="p">(){</span>
        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://sqs.ap-northeast-1.amazonaws.com/626394096352/MA-fujishiroms-sqs-standard&quot;</span><span class="p">;</span>

        <span class="o">//</span> <span class="n">送信するデータの作成</span>
        <span class="n">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Random</span><span class="p">();</span>
        <span class="nb">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">;</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">valueOf</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>

        <span class="n">SendMessageRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SendMessageRequest</span><span class="p">()</span>
                <span class="o">.</span><span class="n">withQueueUrl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="o">.</span><span class="n">withMessageBody</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="o">.</span><span class="n">withDelaySeconds</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="n">amazonSQSClient</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="main">
<h3><span class="section-number">4.2.3. </span>main<a class="headerlink" href="#main" title="この見出しへのパーマリンク">¶</a></h3>
<p>src/main/javaにSqsProducerApplicationクラスを作成する<br />このクラスは、Appのmainクラスであり、jarファイルを実行するとこのクラスのmainが実行される。</p>
<p>処理としては、数字を引数を受け取って、その数だけSQSにメッセージを送信する。引数がなければ10回メッセージを送信する。</p>
<ul class="simple">
<li><p>&#64;SpringBootApplication<br />プロジェクト内のクラスを読み込んで、アプリケーションの設定やBeanの設定をする。これによりSpringはDIを行うことができ、各種設定済みのインスタンスを利用することができる</p></li>
<li><p>ApplicationContext<br />Spring Applicationが実行され、contextの中にBeanなどで定義されたインスタンスが格納される。</p></li>
<li><p>context.getBean(MessageSender.class)<br />contextの中にあるBeanをとりだす。MessageSenderは&#64;Componentで定義されているのでcontext内にBeanガ注入されている。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>package com.msa.aws.sqs.sqs_producer;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.ApplicationContext;
//実行時に各種のアノテーションを読み込んで、DIする
@SpringBootApplication
public class SqsProducerApplication {
    //java実行時に最初に呼び出される
    public static void main(String[] args) {
        int executionCount = 10;

        if (args.length&gt;0){
            executionCount = Integer.parseInt(args[0]);
        }
        // SQSProducerApplicationの呼び出されることで@SpringBootApplicationにより作成されたBeanなどがcontextに格納される
        ApplicationContext context = SpringApplication.run(SqsProducerApplication.class, args);
        for (int i = 0; i &lt; executionCount; i++){
            //context内部に管理されているBeanをよびだしている
            MessageSender sender = context.getBean(MessageSender.class);
            sender.sendMessage();
        }
    }

}
</pre></div>
</div>
</section>
</section>
<section id="ec2">
<h2><span class="section-number">4.3. </span>EC2からの実行<a class="headerlink" href="#ec2" title="この見出しへのパーマリンク">¶</a></h2>
<section id="jar">
<h3><span class="section-number">4.3.1. </span>jarファイルを移動させる<a class="headerlink" href="#jar" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>キーペアのコピー</p>
<ul>
<li><p>作成した、キーペアをworkspacesにコピーしておく（ファイルのコピーはできないので、テキストベースでコピーする。</p></li>
</ul>
</li>
<li><p>権限付与</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="mi">600</span> <span class="n">XXXX</span><span class="o">.</span><span class="n">pem</span> 
</pre></div>
</div>
<ul class="simple">
<li><p>ファイルコピーコマンド実行</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;EC2秘密鍵&#39;</span> <span class="s1">&#39;ローカルの転送したいファイル&#39;</span> <span class="s1">&#39;EC2ユーザー名@IPアドレス:ファイル配置先 </span>

<span class="n">EX</span><span class="p">)</span><span class="n">scp</span> <span class="o">-</span><span class="n">i</span> <span class="o">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">XXX</span><span class="o">.</span><span class="n">pem</span> <span class="n">TEST</span><span class="o">.</span><span class="n">txt</span> <span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">@</span><span class="mf">12.34.567.890</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span>
</pre></div>
</div>
</section>
<section id="java">
<h3><span class="section-number">4.3.2. </span>javaのインストール<a class="headerlink" href="#java" title="この見出しへのパーマリンク">¶</a></h3>
<p>EC2にjavaをインストールして、jarファイルを実行する</p>
<p>javaのインストール</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="n">java</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="n">amazon</span><span class="o">-</span><span class="n">corretto</span>
</pre></div>
</div>
<p>実行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">XXX</span><span class="o">.</span><span class="n">jar</span>
</pre></div>
</div>
</section>
<section id="id13">
<h3><span class="section-number">4.3.3. </span>結果<a class="headerlink" href="#id13" title="この見出しへのパーマリンク">¶</a></h3>
<p>Producer側のjarファイルを実行</p>
<p><img alt="../_images/sqs_tutorial_producer.png" src="../_images/sqs_tutorial_producer.png" /></p>
<p>Consumer側のjarファイルを実行すると、メッセージを取得することができる</p>
<p><img alt="../_images/sqs_tutorial_consumer.png" src="../_images/sqs_tutorial_consumer.png" /></p>
<p>CloudWatchでApproximateNumberOfMessagesVisibleを確認するとConsumer側ではメッセージを削除するので、Produceした分増えた後、Consumeした分減る</p>
<p><img alt="../_images/sqs_tutorial_metrix.png" src="../_images/sqs_tutorial_metrix.png" /></p>
</section>
</section>
<section id="java-consumer">
<h2><span class="section-number">4.4. </span>Javaのプログラム作成（Consumer<a class="headerlink" href="#java-consumer" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id14">
<h3><span class="section-number">4.4.1. </span>Config<a class="headerlink" href="#id14" title="この見出しへのパーマリンク">¶</a></h3>
<p>Producerと同様の設定を行うが、今回は、非同期で、メッセージを処理するため、Asyncのクライアントを作成する</p>
<ul class="simple">
<li><p>amazonSQSAsyncClient<br />非同期でsqsからのメッセージを受信して、処理するメソッド</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">sqsConfig</span> <span class="p">{</span>
    <span class="nd">@Bean</span>
    <span class="n">public</span> <span class="n">AmazonSQSAsync</span> <span class="n">amazonSQSAsyncClient</span><span class="p">(){</span>
        <span class="k">return</span> <span class="n">AmazonSQSAsyncClientBuilder</span><span class="o">.</span><span class="n">defaultClient</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="frontend">
<h3><span class="section-number">4.4.2. </span>frontend<a class="headerlink" href="#frontend" title="この見出しへのパーマリンク">¶</a></h3>
<p>ECSに載せるための動作確認用とhelthcheck用に文字列を返すページを準備したい。その為のControllerを作成しておく</p>
<ul class="simple">
<li><p>&#64;RestController<br />クラスレベルで用いられる。対象クラスがRESTful Webサービスのコントローラーであることを示す。このクラスが付与されているとSpringによってBean管理されて、HTTPリクエストを処理する</p></li>
<li><p>&#64;RequestMapping<br />メソッドレベルで用いられる。指定したパスへのリクエストをfrontend()で処理する。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_consumer</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="p">;</span>

<span class="nd">@RestController</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">frontendController</span> <span class="p">{</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;/sqs-consumer&quot;</span><span class="p">,</span> <span class="n">produces</span> <span class="o">=</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">)</span>
    <span class="n">public</span> <span class="n">String</span> <span class="n">frontend</span><span class="p">(){</span>
        <span class="k">return</span> <span class="s2">&quot;Hello sqs-consumer!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="messagereceiver">
<h3><span class="section-number">4.4.3. </span>MessageReceiver<a class="headerlink" href="#messagereceiver" title="この見出しへのパーマリンク">¶</a></h3>
<p>SQSからメッセージを受信して、処理するクラス。</p>
<ul class="simple">
<li><p>MessageReceiver<br />Configクラスで設定したamazonSQSAsyncClientのインスタンスを取得</p></li>
<li><p>ReceiveMessageRequest<br />リクエストの設定。受信数やロングポーリングの時間などを設定</p></li>
<li><p>sqsAsyncClient.receiveMessage<br />非同期でメッセージを受信してメッセージをリストで返却</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>package com.msa.aws.sqs.sqs_consumer;

import com.amazonaws.services.sqs.AmazonSQSAsync;
import com.amazonaws.services.sqs.model.Message;
import com.amazonaws.services.sqs.model.ReceiveMessageRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
@Component
public class MessageReceiver implements Runnable {

    private static final String QUEUE_URL = &quot;https://sqs.ap-northeast-1.amazonaws.com/626394096352/MA-fujishiroms-sqs-standard&quot;;
    private static final int MAX_NUMBER_OF_MESSAGES = 10; // 一度に受信する最大メッセージ数
    private static final int WAIT_TIME_SECONDS = 20; // メッセージがない場合のロングポーリング待機時間
    private final AmazonSQSAsync sqsAsyncClient;

    @Autowired
    public MessageReceiver(AmazonSQSAsync sqsAsyncClient) {
        this.sqsAsyncClient = sqsAsyncClient;
    }

    @Override
    public void run() {
        while (true) {
            // 受信用のリクエスト作成
            final ReceiveMessageRequest receiveMessageRequest = new ReceiveMessageRequest(QUEUE_URL)
                    .withMaxNumberOfMessages(MAX_NUMBER_OF_MESSAGES)
                    .withWaitTimeSeconds(WAIT_TIME_SECONDS);

            // 受信リクエストの設定を入力としてSQSからメッセージを受信
            final List&lt;Message&gt; messages = sqsAsyncClient.receiveMessage(receiveMessageRequest).getMessages();



            DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;);
            for (final Message message : messages) {
                System.out.println(&quot;======================================================= start =======================================================&quot; );

                //処理開始時間の表示
                LocalDateTime now_bf = LocalDateTime.now();
                System.out.println(&quot;Received Time: &quot; + formatter.format(now_bf));

                //メッセージ内容の表示
                System.out.println(&quot;Message&quot;);
                System.out.println(&quot;Body:          &quot; + message.getBody());
                //メッセージの処理（今回は待機するだけ）
                int waitTime = Integer.parseInt(message.getBody()) * 1000;
                System.out.println(&quot;wait time: &quot; + waitTime);
                waitInMilliseconds(waitTime);
                //メッセージの削除
                sqsAsyncClient.deleteMessage(QUEUE_URL, message.getReceiptHandle());

                //処理完了時間の表示
                LocalDateTime now_af = LocalDateTime.now();
                System.out.println(&quot;Processed Time: &quot; + formatter.format(now_af));
                System.out.println(&quot;======================================================= end =======================================================&quot; );

            }
        }
    }


    //数字を受け取って、その時間待機するためのメソッド
    private void waitInMilliseconds(int milliseconds) {
        try {
            Thread.sleep(milliseconds);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            e.printStackTrace();
        }
    }
}
</pre></div>
</div>
</section>
<section id="id15">
<h3><span class="section-number">4.4.4. </span>main<a class="headerlink" href="#id15" title="この見出しへのパーマリンク">¶</a></h3>
<p>このクラスは、Appのmainクラスであり、jarファイルを実行するとこのクラスのmainが実行される。</p>
<ul class="simple">
<li><p>implements CommandLineRunner<br />このインターフェースを実装すると、Spring Bootアプリケーションが起動した直後にrunメソッドが呼び出されます。</p></li>
<li><p>&#64;Autowired<br />MessageReciverをDIしている</p></li>
<li><p>Thread messageReceiverThread = new Thread(messageReceiver);<br />MessageReciverで定義されているrunが実行される</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">msa</span><span class="o">.</span><span class="n">aws</span><span class="o">.</span><span class="n">sqs</span><span class="o">.</span><span class="n">sqs_consumer</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.CommandLineRunner</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="p">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">SqsConsumerApplication</span> <span class="n">implements</span> <span class="n">CommandLineRunner</span> <span class="p">{</span>

	<span class="n">private</span> <span class="n">final</span> <span class="n">MessageReceiver</span> <span class="n">messageReceiver</span><span class="p">;</span>

	<span class="nd">@Autowired</span>
	<span class="n">public</span> <span class="n">SqsConsumerApplication</span><span class="p">(</span><span class="n">MessageReceiver</span> <span class="n">messageReceiver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">.</span><span class="n">messageReceiver</span> <span class="o">=</span> <span class="n">messageReceiver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SpringApplication</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">SqsConsumerApplication</span><span class="o">.</span><span class="n">class</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="nd">@Override</span>
	<span class="n">public</span> <span class="n">void</span> <span class="n">run</span><span class="p">(</span><span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Thread</span> <span class="n">messageReceiverThread</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">messageReceiver</span><span class="p">);</span>
		<span class="n">messageReceiverThread</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="fifo">
<h2><span class="section-number">4.5. </span>FIFOキューを利用するための改修<a class="headerlink" href="#fifo" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id16">
<h3><span class="section-number">4.5.1. </span>方針<a class="headerlink" href="#id16" title="この見出しへのパーマリンク">¶</a></h3>
<p>FIFOキューを利用するためには、Producer側で宛先を変更してfifoキューに送信する必要がある。
また、FIFOキューを利用するためにはメッセージグループIDが必須であり、メッセージ重複IDを任意で設定することができるので、この対応お行なう。</p>
<p>Consumerはポーリングするキューを変更すれば良い。</p>
</section>
<section id="id17">
<h3><span class="section-number">4.5.2. </span>開発方針<a class="headerlink" href="#id17" title="この見出しへのパーマリンク">¶</a></h3>
<p>Producer側はapplication.yamlでキューのURLを準備しておき、実行時に利用するyamlファイルを変更することで宛先を変更する。また、ソースコード内部でキュー名からfifoキューか否かを判断して、メッセージグループIDなどの設定有無を決定する。</p>
<p>Consumer側はポーリングするキューを変更するために、application.yamlを準備して、DockerFileの実行コマンドを変更する。
Consumeするキューを変更したい場合は、DocokerFIleを変更してリリースし直す必要がある点に注意</p>
</section>
<section id="id18">
<h3><span class="section-number">4.5.3. </span>FIFOキューの作成<a class="headerlink" href="#id18" title="この見出しへのパーマリンク">¶</a></h3>
<p>注意点としてはfifoキューは名前の最後を.fifoとする</p>
<p><img alt="../_images/sqs_fifo_setting1.png" src="../_images/sqs_fifo_setting1.png" />
<img alt="../_images/sqs_fifo_setting2.png" src="../_images/sqs_fifo_setting2.png" />
<img alt="../_images/sqs_fifo_setting3.png" src="../_images/sqs_fifo_setting3.png" />
<img alt="../_images/sqs_fifo_setting4.png" src="../_images/sqs_fifo_setting4.png" /></p>
</section>
<section id="producer">
<h3><span class="section-number">4.5.4. </span>Producerの修正<a class="headerlink" href="#producer" title="この見出しへのパーマリンク">¶</a></h3>
<p>application-standard.ymlとapplication-fifo.yamlを作成する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aws</span><span class="p">:</span>
  <span class="n">sqs</span><span class="p">:</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">sqs</span><span class="o">.</span><span class="n">ap</span><span class="o">-</span><span class="n">northeast</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="p">[</span><span class="n">AccountID</span><span class="p">]</span><span class="o">/</span><span class="n">MA</span><span class="o">-</span><span class="n">fujishiroms</span><span class="o">-</span><span class="n">sqs</span><span class="o">-</span><span class="n">standard</span>
</pre></div>
</div>
<p>Message SenderのURLをapplication.ymlから受け取るように変更する</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Component</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">MessageSender</span> <span class="p">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">private</span> <span class="n">AmazonSQS</span> <span class="n">amazonSQSClient</span><span class="p">;</span>

    <span class="nd">@Value</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{aws.sqs.url}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">private</span> <span class="n">String</span> <span class="n">url</span><span class="p">;</span>
</pre></div>
</div>
<p>なお、このままパッケージングしようとすると、{aws.sqs.url}を解決することができないので、testクラスでstandardを利用するように設定するか、デフォルトのapplication.ymlを作成するか対策が必要</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@SpringBootTest</span>
<span class="nd">@ActiveProfiles</span><span class="p">(</span><span class="s2">&quot;standard&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SqsProducerApplicationTests</span> <span class="p">{</span>
</pre></div>
</div>
<p>メッセージ送信する際に、キューの名前を確認して、fifoキューならメッセージグループIDやメッセージ重複IDを指定するようにする。
以下の実装では、UUIDを利用して、すべて異なるメッセージグループIDを発行するように変更。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">メッセージ送信</span>
<span class="n">SendMessageRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SendMessageRequest</span><span class="p">()</span>
        <span class="o">.</span><span class="n">withQueueUrl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="o">.</span><span class="n">withMessageBody</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="o">.</span><span class="n">withDelaySeconds</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">endsWith</span><span class="p">(</span><span class="s2">&quot;.fifo&quot;</span><span class="p">)){</span>
    <span class="n">request</span><span class="o">.</span><span class="n">withMessageGroupId</span><span class="p">(</span><span class="n">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
            <span class="o">.</span><span class="n">withMessageDeduplicationId</span><span class="p">(</span><span class="n">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="p">()</span><span class="o">.</span><span class="n">toString</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>あとは、実行する際にapplication.ymlの指定をすれば標準キューとFIFOキューへ送信を変更できる</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">### 標準キュー</span>
<span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">sqs_producer</span><span class="o">-</span><span class="mf">0.0.1</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">.</span><span class="n">jar</span> <span class="mi">10</span> <span class="o">--</span><span class="n">spring</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">active</span><span class="o">=</span><span class="n">standard</span>

<span class="c1">### FIFOキュー</span>
<span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">sqs_producer</span><span class="o">-</span><span class="mf">0.0.1</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">.</span><span class="n">jar</span> <span class="mi">10</span> <span class="o">--</span><span class="n">spring</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">active</span><span class="o">=</span><span class="n">fifo</span>
</pre></div>
</div>
</section>
<section id="consumer">
<h3><span class="section-number">4.5.5. </span>Consumerの修正<a class="headerlink" href="#consumer" title="この見出しへのパーマリンク">¶</a></h3>
<p>送信側のSQSのURLをapplication-{xxx}.ymlに記述して、クラス側で受け取るように変更</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Component</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">MessageReceiver</span> <span class="n">implements</span> <span class="n">Runnable</span> <span class="p">{</span>

    <span class="nd">@Value</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{aws.sqs.url}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">private</span> <span class="n">String</span> <span class="n">QUEUE_URL</span><span class="p">;</span>
</pre></div>
</div>
<p>DockerFIleを変更して、どちらのECSにするかを設定する。
毎回デプロイが必要な点に注意</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Javaの実行</span>
<span class="n">CMD</span> <span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">sqs_consumer</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">sqs_consumer</span><span class="o">-</span><span class="mf">0.0.1</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">.</span><span class="n">jar</span> <span class="o">--</span><span class="n">spring</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">active</span><span class="o">=</span><span class="n">standard</span>
</pre></div>
</div>
<p>合わせて、オートスケーリングの検証も行いたい場合は、FIFOキューを監視するアラートを作成し、ECSのサービスの設定で利用するアラートをFIFOキューのものに変更する必要がある点に注意</p>
</section>
</section>
</section>
<section id="id19">
<h1><span class="section-number">5. </span>SQSのオートスケーリング設定<a class="headerlink" href="#id19" title="この見出しへのパーマリンク">¶</a></h1>
<section id="id20">
<h2><span class="section-number">5.1. </span>基本方針<a class="headerlink" href="#id20" title="この見出しへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><p>監視</p>
<ul>
<li><p>CloudWatchアラームを設定して、処理できるキューの数(ApproximateNumberOfMessagesVisible)を監視する。</p></li>
<li><p>スケールアウト用の監視とスケールイン用の監視を作成</p></li>
</ul>
</li>
<li><p>オートスケール</p>
<ul>
<li><p>キューが少しでも溜まったら、台数を8件に変更する。</p></li>
<li><p>キューのメッセージ数が5分連続で0になったらスケールインする</p></li>
</ul>
</li>
<li><p>確認項目</p>
<ul>
<li><p>メトリクスのログを確認して、減り方が一定であることを確認（漸減しない）</p></li>
<li><p>1000件全てが正しく処理されているか確認</p></li>
<li><p>オートスケールした各コンテナのログを確認して重複処理していないか確認</p></li>
<li><p>オートスケールした各コンテナのログを確認して最後の処理について処理タイミングが同じか確認</p></li>
</ul>
</li>
</ul>
</section>
<section id="id21">
<h2><span class="section-number">5.2. </span>監視設定<a class="headerlink" href="#id21" title="この見出しへのパーマリンク">¶</a></h2>
<p>以下の手順でスケールアウトとスケールインのメトリクスを作成</p>
<ul class="simple">
<li><p>CloudWatchAlarmsからアラームの作成</p>
<ul>
<li><p>MA-fujishiroms-sqs-alarms-scaleOUT</p></li>
<li><p>MA-fujishiroms-sqs-alarms-scaleIN</p></li>
</ul>
</li>
<li><p>メトリクスとしてSQS&gt;キューイングメトリクス&gt;ApproximateNumberOfMessagesVisibleを選択</p></li>
<li><p>各種設定を行う</p>
<ul>
<li><p>統計：最大（メトリクスとして収集するデータをどの集計値にするか）</p></li>
<li><p>期間：1分（詳細メトリクスの設定をしない場合は1分が最短）</p></li>
<li><p>閾値の種類：静的（異常検出はMLによって異常値を検出する）</p></li>
<li><p>アラームを実行するポイント：メトリクスが何回閾値を超えたらアラームを出すか</p>
<ul>
<li><p>スケールアウト：10以上となったデータが一回でもあればアラーム</p></li>
<li><p>スケールイン：0以下となったデータが5分連続したらアラーム</p></li>
</ul>
</li>
<li><p>アクションの設定は一旦設定なしでOK</p></li>
</ul>
</li>
</ul>
<p><img alt="../_images/sqs_alarms_scaleout.png" src="../_images/sqs_alarms_scaleout.png" /></p>
<p><img alt="../_images/sqs_alarms_scalein.png" src="../_images/sqs_alarms_scalein.png" /></p>
</section>
<section id="id22">
<h2><span class="section-number">5.3. </span>オートスケール設定<a class="headerlink" href="#id22" title="この見出しへのパーマリンク">¶</a></h2>
<p>ECSのサービスからオートスケーリングの設定を行う。サービスを選択し、更新</p>
<ul class="simple">
<li><p>スケールアウトとスケールインのポリシーを設定する</p>
<ul>
<li><p>MA-fujishiroms-sqs-consumer-scaleOUT-policy</p></li>
<li><p>MA-fujishiroms-sqs-consumer-scaleIN-policy</p></li>
</ul>
</li>
<li><p>サービスのAuto Scalingから最小数と最大数を設定</p>
<ul>
<li><p>最大数：10</p></li>
<li><p>最小数：1</p></li>
</ul>
</li>
<li><p>スケーリングポリシー</p>
<ul>
<li><p>ポリシータイプ：ステップスケーリング</p></li>
<li><p>CloudWatchアラーム名：事前作成したもの</p></li>
<li><p>アクション:スケール<em>アウト</em></p>
<ul>
<li><p>アクション：add</p></li>
<li><p>値：10</p></li>
<li><p>タイプ：タスク</p></li>
<li><p>下限：10(どの値でスケールアウトさせるか)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>アクション:スケール<em>イン</em>
- アクション：Remove
- 値：10
- タイプ：タスク
- 上限：0(どの値でスケールインさせるか)</p></li>
</ul>
<p><img alt="../_images/sqs_autoscaling_scaleout.png" src="../_images/sqs_autoscaling_scaleout.png" /></p>
<p><img alt="../_images/sqs_autoscaling_scalein.png" src="../_images/sqs_autoscaling_scalein.png" /></p>
</section>
<section id="id23">
<h2><span class="section-number">5.4. </span>動作確認<a class="headerlink" href="#id23" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id24">
<h3><span class="section-number">5.4.1. </span>オートスケールの挙動<a class="headerlink" href="#id24" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>producerで1000件のデータをSQSへ送信</p></li>
<li><p>スケールアウトについては、アラートはうまく発出されて、スケールアウトも動作した。</p></li>
<li><p>スケールインに関しても5分間連続で値が閾値を超えることでアラートが発出され、スケールインも実施された。</p></li>
</ul>
<p><img alt="../_images/sqs_scaleout_alart.png" src="../_images/sqs_scaleout_alart.png" /></p>
</section>
<section id="id25">
<h3><span class="section-number">5.4.2. </span>ログの分析<a class="headerlink" href="#id25" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>メトリクスのログを確認して、減り方が一定であることを確認（漸減しない）</p>
<ul>
<li><p>上記のスケールアウトのメトリクスを見ても、処理の最後の方でも漸減していない。そのため、特定のコンテナだけが処理をして、他のコンテナがメッセージを受け取っていないようには見えない。</p></li>
</ul>
</li>
<li><p>1000件全てが正しく処理されているか確認</p>
<ul>
<li><p>ログを確認して、処理終了のログを集計したところ1000件は全て処理されている。</p></li>
</ul>
</li>
<li><p>オートスケールした各コンテナのログを確認して重複処理していないか確認</p>
<ul>
<li><p>処理完了の件数を確認したところ1000件だったため、重複して処理しているものはない。</p></li>
<li><p>SQSの公式ドキュメントでは最低一回の補償なので、二回行われる可能性もある</p></li>
</ul>
</li>
<li><p>オートスケールした各コンテナのログを確認して最後の処理について処理タイミングが同じか確認</p>
<ul>
<li><p>ログから書くコンテナの処理件数と最後の処理の終了時刻を取得</p></li>
<li><p>コンテナ５が件数多いものの、終了日時はずれていない。</p></li>
<li><p>コンテナ5に入った処理が軽かっただけと推察。この辺りは処理時間を長くして動作確認したい。</p>
<ul>
<li><p>コンテナ１：118件処理・4:30:23</p></li>
<li><p>コンテナ２：110件処理・4:30:16</p></li>
<li><p>コンテナ３：120件処理・4:30:39</p></li>
<li><p>コンテナ４：122件処理・4:30:35</p></li>
<li><p>コンテナ５：167件処理・4:30:40</p></li>
<li><p>コンテナ６：120件処理・4:30:46</p></li>
<li><p>コンテナ７：113件処理・4:30:10</p></li>
<li><p>コンテナ８：130件処理・4:30:29</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
</section>
<section id="id26">
<h2><span class="section-number">5.5. </span>標準キューでの検証<a class="headerlink" href="#id26" title="この見出しへのパーマリンク">¶</a></h2>
<p>7/17 10:30~1000件投入<br />合計4971secの待ち処理になっていた(約83分で5台処理で16分)　　
処理自体は19分で完了</p>
<p><img alt="../_images/sqs_standard_0.png" src="../_images/sqs_standard_0.png" /></p>
<p>標準キューのため、ベストエフォートで処理順は担保されている。
オートスケーリングした場合は、同時にConsumerに取得されたメッセージで処理順が担保されるが、複数のConsumer間ではメッセージの順序は担保されない。</p>
<p>動作を確認しても、複数のConsumerが協調しながら処理をしているのがわかる</p>
<section id="id27">
<h3><span class="section-number">5.5.1. </span>時系列<a class="headerlink" href="#id27" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>10:30 データ1000件投入</p></li>
<li><p>10:30-34 常時起動のconsumer1台が処理（オートスケール中も問題なく処理）</p></li>
</ul>
<p><img alt="../_images/sqs_standard_5.png" src="../_images/sqs_standard_5.png" /></p>
<ul class="simple">
<li><p>10:34 オートスケール完了</p></li>
</ul>
<p><img alt="../_images/sqs_standard_2.png" src="../_images/sqs_standard_2.png" /></p>
<ul class="simple">
<li><p>5台のconsumer5台が処理開始（各処理がバラバラに実施）</p></li>
</ul>
<p><img alt="../_images/sqs_standard_6.png" src="../_images/sqs_standard_6.png" /></p>
<p>もう少し具体的にみると異なるConsumerで異なるメッセージを同じタイミングで処理している</p>
<p><img alt="../_images/sqs_standard_7.png" src="../_images/sqs_standard_7.png" /></p>
</section>
</section>
<section id="id28">
<h2><span class="section-number">5.6. </span>FIFOキューでの検証<a class="headerlink" href="#id28" title="この見出しへのパーマリンク">¶</a></h2>
<p>メッセージグループIDを全て異なるものと同じものにして検証してみる</p>
<section id="id">
<h3><span class="section-number">5.6.1. </span>メッセージグループIDを同じものにした場合<a class="headerlink" href="#id" title="この見出しへのパーマリンク">¶</a></h3>
<p>7/16 1020~1000件投入<br />合計5010secの待ち処理になっていた(約83分)　
処理自体も1時間23分で完了</p>
<p><img alt="../_images/sqs_fifo_alart_same_message_id.png" src="../_images/sqs_fifo_alart_same_message_id.png" /></p>
<p>すべて同じメッセージグループIDにした場合は、想定通り同時に複数のConsumerがConsumeすることができないようで、処理速度が遅くなった。これはkafkaだとpartitionを1に設定したようなもので、オートスケールしているにも関わらず、１台分のConsumerしか処理していない。</p>
<p>ログを確認してみても、同じタイミングでConsumerが処理するのではなくシリアルにConsumerが処理するような動きになっている。(待機が終わってから次の処理が実行されている)</p>
<p>オートスケールしたとしても、同時に取得できる10件ごとに同じConsumerが処理して、次の10件は別のConsumerが処理しており、1台起動しているのと、効率は変わらない。</p>
<p><img alt="../_images/sqs_fifo_log_same_message_id_2.png" src="../_images/sqs_fifo_log_same_message_id_2.png" /></p>
<p>1分単位で処理を見てみても、同時処理していないため、効率は悪い。
（１分でまとめているので一部協調して処理しているように見えるが実態は、重なっていない。</p>
<p><img alt="../_images/sqs_fifo_log_same_message_id_3.png" src="../_images/sqs_fifo_log_same_message_id_3.png" /></p>
</section>
<section id="id29">
<h3><span class="section-number">5.6.2. </span>メッセージグループIDをすべて異なるものにした場合<a class="headerlink" href="#id29" title="この見出しへのパーマリンク">¶</a></h3>
<p>7/16 1245~実施</p>
<p>すべて異なるメッセージグループIDにした場合は、5台が協調して実施するため、処理が素早い。(左がグループID同じ・右がグループID異なる)。1台処理で1時間20分程度掛かっていた処理が5台処理なので、20分程度で終わる。</p>
<p><img alt="../_images/sqs_fifo_single_vs_multi.png" src="../_images/sqs_fifo_single_vs_multi.png" /></p>
<p>もちろんグループIDが異なるので、異なるグループID間の処理順序はFIFOキューであっても担保されない点に注意</p>
<section id="id30">
<h4><span class="section-number">5.6.2.1. </span>時系列<a class="headerlink" href="#id30" title="この見出しへのパーマリンク">¶</a></h4>
<ul class="simple">
<li><p>12:45 データ1000件投入<br />合計4958secの待ち処理になっていた(約82分で5台処理で15分)　　
処理自体は20分で完了</p></li>
<li><p>12:45-12:49 常時起動のconsumer1台が処理（オートスケール中も問題なく処理）</p></li>
</ul>
<p><img alt="../_images/sqs_fifo_multi_message_id_4.png" src="../_images/sqs_fifo_multi_message_id_4.png" /></p>
<ul class="simple">
<li><p>12:49 オートスケール完了</p></li>
</ul>
<p><img alt="../_images/sqs_fifo_multi_message_id_2.png" src="../_images/sqs_fifo_multi_message_id_2.png" /></p>
<ul class="simple">
<li><p>12:49 5台のconsumer5台が処理開始（各処理がバラバラに実施）</p></li>
</ul>
<p><img alt="../_images/sqs_fifo_multi_message_id_5.png" src="../_images/sqs_fifo_multi_message_id_5.png" /></p>
<p>分単位でまとめてみても、協調して処理していることがわかる
<img alt="../_images/sqs_fifo_multi_message_id_6.png" src="../_images/sqs_fifo_multi_message_id_6.png" /></p>
</section>
</section>
</section>
</section>
<section id="id31">
<h1><span class="section-number">6. </span>メトリクスについて<a class="headerlink" href="#id31" title="この見出しへのパーマリンク">¶</a></h1>
<p>ApproximateNumberOfMessageVisibleは、consumerに左右されないはず。
consumerを0台として、2週間放置後、1000件を投入して正しく処理されるかを確認</p>
<section id="autoscaling">
<h2><span class="section-number">6.1. </span>AutoScaling無し<a class="headerlink" href="#autoscaling" title="この見出しへのパーマリンク">¶</a></h2>
<ul class="simple">
<li><p>SQS Standardキューにメッセージを投入して動作していることを確認(7/17 10:50)</p></li>
</ul>
<p><img alt="../_images/sqs_standard_0.png" src="../_images/sqs_standard_0.png" /></p>
<ul class="simple">
<li><p>fifoキューをconsumeするコンテナをデプロイすることでconsumerが0台に(7/17 11:15)</p></li>
<li><p>同時にオートスケーリングの設定で監視するアラームを変更して、アラートのアクションを停止</p></li>
</ul>
<p><img alt="../_images/sqs_standard_alarm_check_1.png" src="../_images/sqs_standard_alarm_check_1.png" /></p>
<p><img alt="../_images/sqs_standard_alarm_check_2.png" src="../_images/sqs_standard_alarm_check_2.png" /></p>
<p>3日後にメトリクスの様子を確認(7/19 12:00)</p>
<p>7日後にメトリクスの様子を確認(7/23 12:00)</p>
<p>14日後にメトリクスの様子を確認(7/30 12:00)</p>
<p>14日後にデータを投入してメトリクスが増加するか確認(7/30 14:00)</p>
</section>
<section id="id32">
<h2><span class="section-number">6.2. </span>AutoScaling有り<a class="headerlink" href="#id32" title="この見出しへのパーマリンク">¶</a></h2>
<p>SQS FIFOキューにメッセージを投入して動作していることを確認(7/17 11:30)</p>
<p><img alt="../_images/sqs_fifo_alart_check_1.png" src="../_images/sqs_fifo_alart_check_1.png" /></p>
<p>consumerを0台にする(7/17 11:40)</p>
<p><img alt="../_images/sqs_fifo_alart_check_2.png" src="../_images/sqs_fifo_alart_check_2.png" /></p>
<p>3日後にメトリクスの様子を確認(7/20 12:00)</p>
<p>7日後にメトリクスの様子を確認(7/24 12:00)</p>
<p>14日後にメトリクスの様子を確認(7/31 12:00)</p>
<p>14日後にデータを投入してメトリクスが増加するか、オートスケールするか確認(7/31 14:00)</p>
</section>
<section id="id33">
<h2><span class="section-number">6.3. </span>トラブルシューティング<a class="headerlink" href="#id33" title="この見出しへのパーマリンク">¶</a></h2>
<section id="id34">
<h3><span class="section-number">6.3.1. </span>オートスケールが8台しか起動しない問題の確認<a class="headerlink" href="#id34" title="この見出しへのパーマリンク">¶</a></h3>
<section id="id35">
<h4><span class="section-number">6.3.1.1. </span>アラート確認<a class="headerlink" href="#id35" title="この見出しへのパーマリンク">¶</a></h4>
<p>ApproximateNumerOfMessageVisibleを正しく設定できている。
統計情報も期間も正しい。</p>
<p><img alt="../_images/sqs_alarmsetting-1.png" src="../_images/sqs_alarmsetting-1.png" /></p>
<p>条件も閾値の種別も、1以上のメッセージの蓄積を検知して、アラートがなるように設定されている。</p>
<p><img alt="../_images/sqs_alarmsetting-2.png" src="../_images/sqs_alarmsetting-2.png" /></p>
<p>メッセージを送信した際も、正しくメトリクスが増加しているのを確認</p>
<p><img alt="../_images/sqs_alarm_10.png" src="../_images/sqs_alarm_10.png" /></p>
</section>
<section id="id36">
<h4><span class="section-number">6.3.1.2. </span>オートスケーリング設定確認<a class="headerlink" href="#id36" title="この見出しへのパーマリンク">¶</a></h4>
<p>タスクの最大数を10に設定し、アラームの設定や追加のアクションとしても1台の常時起動に加えて、9台追加起動の設定をしている</p>
<p><img alt="../_images/sqs_autoscaling-setting.png" src="../_images/sqs_autoscaling-setting.png" /></p>
</section>
<section id="id37">
<h4><span class="section-number">6.3.1.3. </span>10台の実行確認<a class="headerlink" href="#id37" title="この見出しへのパーマリンク">¶</a></h4>
<p>やはり、8台起動となってしまう。</p>
<p><img alt="../_images/sqs_scaleout_10.png" src="../_images/sqs_scaleout_10.png" /></p>
</section>
<section id="id38">
<h4><span class="section-number">6.3.1.4. </span>分析<a class="headerlink" href="#id38" title="この見出しへのパーマリンク">¶</a></h4>
<p>ヘルスチェックがうまくいっていないのでは？と思い、TGを確認したが8台は全てOKで、残りの２台はNGと出ていないので、立ち上がってすらいない。
この表を見てIPが怪しいのでは？と思い始める。</p>
<p><img alt="../_images/sqs_scaleout_10_tg.png" src="../_images/sqs_scaleout_10_tg.png" /></p>
<p>タスクがどのように立ち上がっているかのログがあるので確認したところ、２台のコンテナを立ち上げようとしては失敗していることを確認</p>
<p><img alt="../_images/sqs_scaling_log.png" src="../_images/sqs_scaling_log.png" /></p>
<p>このインスタンスのログが観れるので確認したところ、原因判明。
なんと、IPアドレスが足りないとのこと</p>
<p><img alt="../_images/sqs_autoscaling_reason.png" src="../_images/sqs_autoscaling_reason.png" /></p>
<p>確認したところ、利用しているサブネットはpublicの２つのサブネットで(xx.xx.xx.xx/28)で、利用できるIPは16個*2で32個</p>
<p>ただし、以下の5つのIPはAWSにそれぞれのサブネットで予約されているので残りは22個</p>
<ul class="simple">
<li><p>ネットワークアドレス（xx.xx.xx.0）</p></li>
<li><p>VPCルーターのためのアドレス（xx.xx.xx.1）</p></li>
<li><p>DNS解決のためのアドレス（xx.xx.xx.2）</p></li>
<li><p>AWSによる将来の使用のためのアドレス（xx.xx.xx.3）</p></li>
<li><p>ブロードキャストアドレス（xx.xx.xx.15）</p></li>
</ul>
<p>以下のリソースが11つのIPを利用</p>
<ul class="simple">
<li><p>MSK用のProducer EC2 1台</p></li>
<li><p>SQS用のProducer EC2 1台</p></li>
<li><p>停止中のEC2 3台</p></li>
<li><p>MSK用のConsumer Fargate 1台</p></li>
<li><p>NatGW 1台</p></li>
<li><p>public用のALB(それぞれのサブネットでIPを利用) 1台</p></li>
<li><p>MSKのブローカー２台</p></li>
</ul>
<p>残りは11個あるはずだが、8台しか起動しないというとは、3個意識していないサービスがIPを利用しているようだが、確認することはできていない。いずれにしてもIP数は気をつけなくてはいけない。</p>
<p>停止中のEC2を一台削除して9台になるか確認し、9件になることが確認できた</p>
<p><img alt="../_images/sqs_autoscaling_9.png" src="../_images/sqs_autoscaling_9.png" /></p>
</section>
<section id="aws">
<h4><span class="section-number">6.3.1.5. </span>AWSの不具合？あんまり好ましくない挙動発見<a class="headerlink" href="#aws" title="この見出しへのパーマリンク">¶</a></h4>
<p>上記のIPの問題で、10台のスケールアウトを設定していて、8台しか立ち上がらない状態になっている場合、残りの２台を立ち続けようとして、スケールアウトのアラートが停止し、スケールインのアラートが発砲されても、スケールインが作動しない。</p>
<ol class="simple">
<li><p>スケールアウトルール起動</p></li>
<li><p>2台立ち上がらないので、サービスの立ち上げを実施し続ける</p></li>
<li><p>SQSのメッセージ処理が終了するのでスケールアウトのアラート停止</p></li>
<li><p>スケールインのアラート発砲</p></li>
<li><p>ECSはスケールアウトが完了していないのでスケールアウトを続けようとする</p></li>
</ol>
<p><img alt="../_images/sqs_autoscaling_error.png" src="../_images/sqs_autoscaling_error.png" /></p>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">2. SQSのチュートリアル実装(CLI編)</a><ul>
<li><a class="reference internal" href="#id1">2.1. キューの作り方</a><ul>
<li><a class="reference internal" href="#cli">2.1.1. CLIで作成する場合</a></li>
<li><a class="reference internal" href="#gui">2.1.2. GUIで作成する場合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dlt">2.2. DLTの設定方法</a></li>
<li><a class="reference internal" href="#id2">2.3. メッセージの送受信方法</a><ul>
<li><a class="reference internal" href="#id3">2.3.1. CLIで送信</a></li>
<li><a class="reference internal" href="#id4">2.3.2. コンソールから送信</a></li>
<li><a class="reference internal" href="#id5">2.3.3. 送信の確認</a></li>
<li><a class="reference internal" href="#id6">2.3.4. コンソールで受信確認</a></li>
<li><a class="reference internal" href="#id7">2.3.5. CLIでメッセージ受信と削除</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#sqs">3. SQSの開発環境構築</a><ul>
<li><a class="reference internal" href="#producerec2">3.1. ProducerのEC2の作成</a></li>
<li><a class="reference internal" href="#producercicd">3.2. ProducerのCICD</a><ul>
<li><a class="reference internal" href="#codedeploy">3.2.1. CodeDeployの準備</a></li>
<li><a class="reference internal" href="#id8">3.2.2. CodeDeployの設定</a></li>
<li><a class="reference internal" href="#codepipeline">3.2.3. CodePipelineの作成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#consumerecscicd">3.3. ConsumerのECSデプロイとCICD</a><ul>
<li><a class="reference internal" href="#dockerfile">3.3.1. Dockerfileの作成</a></li>
<li><a class="reference internal" href="#ecr">3.3.2. ECRの設定</a></li>
<li><a class="reference internal" href="#buildspec-yml">3.3.3. Buildspec.ymlの作成</a></li>
<li><a class="reference internal" href="#codebuild">3.3.4. CodeBuildの設定</a></li>
<li><a class="reference internal" href="#ecs">3.3.5. ECSの設定</a><ul>
<li><a class="reference internal" href="#iam">3.3.5.1. タスクのIAM準備</a></li>
<li><a class="reference internal" href="#id9">3.3.5.2. タスク定義の設定</a></li>
<li><a class="reference internal" href="#id10">3.3.5.3. サービスの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">3.3.6. CodeDeployの設定</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#sqs-java">4. SQSのチュートリアル実装(Java編)</a><ul>
<li><a class="reference internal" href="#id12">4.1. SQSの作成</a></li>
<li><a class="reference internal" href="#java-producer">4.2. Javaのプログラム作成（Producer</a><ul>
<li><a class="reference internal" href="#config">4.2.1. config</a></li>
<li><a class="reference internal" href="#messagesender">4.2.2. MessageSender</a></li>
<li><a class="reference internal" href="#main">4.2.3. main</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ec2">4.3. EC2からの実行</a><ul>
<li><a class="reference internal" href="#jar">4.3.1. jarファイルを移動させる</a></li>
<li><a class="reference internal" href="#java">4.3.2. javaのインストール</a></li>
<li><a class="reference internal" href="#id13">4.3.3. 結果</a></li>
</ul>
</li>
<li><a class="reference internal" href="#java-consumer">4.4. Javaのプログラム作成（Consumer</a><ul>
<li><a class="reference internal" href="#id14">4.4.1. Config</a></li>
<li><a class="reference internal" href="#frontend">4.4.2. frontend</a></li>
<li><a class="reference internal" href="#messagereceiver">4.4.3. MessageReceiver</a></li>
<li><a class="reference internal" href="#id15">4.4.4. main</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fifo">4.5. FIFOキューを利用するための改修</a><ul>
<li><a class="reference internal" href="#id16">4.5.1. 方針</a></li>
<li><a class="reference internal" href="#id17">4.5.2. 開発方針</a></li>
<li><a class="reference internal" href="#id18">4.5.3. FIFOキューの作成</a></li>
<li><a class="reference internal" href="#producer">4.5.4. Producerの修正</a></li>
<li><a class="reference internal" href="#consumer">4.5.5. Consumerの修正</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id19">5. SQSのオートスケーリング設定</a><ul>
<li><a class="reference internal" href="#id20">5.1. 基本方針</a></li>
<li><a class="reference internal" href="#id21">5.2. 監視設定</a></li>
<li><a class="reference internal" href="#id22">5.3. オートスケール設定</a></li>
<li><a class="reference internal" href="#id23">5.4. 動作確認</a><ul>
<li><a class="reference internal" href="#id24">5.4.1. オートスケールの挙動</a></li>
<li><a class="reference internal" href="#id25">5.4.2. ログの分析</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id26">5.5. 標準キューでの検証</a><ul>
<li><a class="reference internal" href="#id27">5.5.1. 時系列</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id28">5.6. FIFOキューでの検証</a><ul>
<li><a class="reference internal" href="#id">5.6.1. メッセージグループIDを同じものにした場合</a></li>
<li><a class="reference internal" href="#id29">5.6.2. メッセージグループIDをすべて異なるものにした場合</a><ul>
<li><a class="reference internal" href="#id30">5.6.2.1. 時系列</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id31">6. メトリクスについて</a><ul>
<li><a class="reference internal" href="#autoscaling">6.1. AutoScaling無し</a></li>
<li><a class="reference internal" href="#id32">6.2. AutoScaling有り</a></li>
<li><a class="reference internal" href="#id33">6.3. トラブルシューティング</a><ul>
<li><a class="reference internal" href="#id34">6.3.1. オートスケールが8台しか起動しない問題の確認</a><ul>
<li><a class="reference internal" href="#id35">6.3.1.1. アラート確認</a></li>
<li><a class="reference internal" href="#id36">6.3.1.2. オートスケーリング設定確認</a></li>
<li><a class="reference internal" href="#id37">6.3.1.3. 10台の実行確認</a></li>
<li><a class="reference internal" href="#id38">6.3.1.4. 分析</a></li>
<li><a class="reference internal" href="#aws">6.3.1.5. AWSの不具合？あんまり好ましくない挙動発見</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="cloudformaiton_CICD.html"
                          title="前の章へ"><span class="section-number">1. </span>CodePipelineを利用してCFNのCICD環境を作成する</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="MSK.html"
                          title="次の章へ"><span class="section-number">7. </span>MSKのチュートリアル実装(CLI編)</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/HandsOn/SQS.md.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="MSK.html" title="7. MSKのチュートリアル実装(CLI編)"
             >次へ</a> |</li>
        <li class="right" >
          <a href="cloudformaiton_CICD.html" title="1. CodePipelineを利用してCFNのCICD環境を作成する"
             >前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">my_sphinx  ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">2. </span>SQSのチュートリアル実装(CLI編)</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, sphinx_user.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.2.3.
    </div>
  </body>
</html>